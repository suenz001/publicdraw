<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šå¹¸é‹æŠ½æŠ½æ¨‚ - æ——è‰¦ç®¡ç†ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --header-bg: #ffffff;
            --text-color: #333333;
            --primary: #4a90e2;
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            
            --common: #95a5a6; --uncommon: #00b894; --rare: #0984e3;
            --epic: #6c5ce7; --legendary: #e17055; --mythic: #d63031;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0;
            user-select: none; -webkit-user-select: none;
            overflow-x: hidden; padding-bottom: 60px;
        }

        /* === ç™»å…¥ä»‹é¢ === */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .login-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 85%; max-width: 350px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; font-size: 1rem;
        }
        .btn-group-login { display: flex; gap: 10px; margin-top: 15px; }
        .btn-login { flex: 1; background: #4a90e2; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-register { flex: 1; background: #00b894; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-guest { background: #b2bec3; color: white; border: none; padding: 10px; font-size: 0.9rem; border-radius: 50px; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn-forgot { background: none; border: none; color: #888; margin-top: 15px; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        #loadingMsg { color: #888; margin-top: 10px; font-size: 0.9rem; display: none; }
        #loginError { color: red; font-size: 0.8rem; margin-top: 10px; min-height: 1.2em; }

        .user-bar { background: #2d3436; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .btn-logout { background: #d63031; border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        /* === Header & Dropdown === */
        .header { background: var(--header-bg); padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .child-switcher-container { position: relative; display: inline-block; }
        .child-switcher {
            display: inline-block; background: #f1f2f6; padding: 5px 15px; border-radius: 20px; margin-bottom: 10px;
            font-weight: bold; color: #2d3436; cursor: pointer; border: 2px solid #dfe6e9; user-select: none;
        }
        /* ğŸ”´ ä¸‹æ‹‰é¸å–®æ¨£å¼ */
        .dropdown-menu {
            display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%);
            background-color: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            z-index: 101; border-radius: 10px; overflow: hidden; margin-top: 5px;
        }
        .dropdown-menu div { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
        .dropdown-menu div:hover { background-color: #f1f1f1; }
        .show { display: block; }

        .points-val { font-size: 3rem; font-weight: 800; color: #fab1a0; margin: 0; line-height: 1.2; }
        .points-label { font-size: 0.9rem; color: #888; font-weight: bold; }

        .nav { display: flex; background: white; margin: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 5px; }
        .nav-btn { flex: 1; padding: 10px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-size: 0.9rem; }
        .nav-btn.active { background: #dfe6e9; color: #2d3436; }
        .section { display: none; padding: 10px 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .roulette-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .roulette-box { background: #e9ecef; border-radius: 12px; padding: 20px 5px; text-align: center; font-weight: 800; font-size: 1.2rem; opacity: 0.6; color: #555; border: 3px solid transparent; border-bottom-width: 5px; display: flex; flex-direction: column; justify-content: center; min-height: 80px; }
        .roulette-box span { font-size: 0.8rem; font-weight: normal; margin-top: 5px; opacity: 0.8; }
        .roulette-box.active { opacity: 1; transform: scale(1.05); background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10; }
        
        .box-common { border-color: var(--common); } .box-common.active { color: var(--common); }
        .box-uncommon { border-color: var(--uncommon); } .box-uncommon.active { color: var(--uncommon); }
        .box-rare { border-color: var(--rare); } .box-rare.active { color: var(--rare); }
        .box-epic { border-color: var(--epic); } .box-epic.active { color: var(--epic); }
        .box-legendary { border-color: var(--legendary); } .box-legendary.active { color: var(--legendary); }
        .box-mythic { border-color: var(--mythic); } .box-mythic.active { color: var(--mythic); }

        .big-btn { width: 100%; padding: 18px; font-size: 1.4rem; font-weight: bold; border-radius: 50px; border: none; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); cursor: pointer; margin-top: 15px; }
        .big-btn:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; }
        #finalResult { margin-top: 25px; padding: 20px; border-radius: 15px; text-align: center; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        
        .list-item { background: white; border-left: 6px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-use { background: #ff7675; color: white; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .pity-info { background: #fff8e1; color: #d35400; padding: 10px; border-radius: 10px; font-size: 0.85rem; margin-top: 20px; text-align: center; border: 1px solid #ffe0b2; }
        
        .bank-card { background: linear-gradient(135deg, #00b09b, #96c93d); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,176,155,0.3); }
        .bank-rate { font-size: 1.5rem; font-weight: bold; }
        .bank-desc { font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px; }
        .bank-timer { font-family: monospace; font-size: 1.1rem; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-top: 10px; display: inline-block; font-weight: bold;}
        
        .deposit-form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .deposit-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 1.2rem; box-sizing: border-box; text-align: center; }
        .btn-deposit { width: 100%; padding: 12px; background: #00b894; color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .deposit-item { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .deposit-item::before { content: "ğŸ”’"; position: absolute; right: -10px; top: -10px; font-size: 3rem; opacity: 0.1; }
        .deposit-header { display: flex; justify-content: space-between; font-weight: bold; color: #2d3436; margin-bottom: 5px; }
        .deposit-time { font-size: 0.85rem; color: #636e72; }
        .btn-redeem { width: 100%; margin-top: 10px; padding: 8px; background: #fdcb6e; color: #d35400; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-redeem:disabled { background: #dfe6e9; color: #b2bec3; cursor: not-allowed; }
        
        .admin-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-admin { background: #0984e3; color: white; padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; }
        .btn-settings { background: #636e72; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-top:10px; }
        
        .prize-manage-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .btn-mini-del { background: #ff7675; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; margin-left: 5px;}
        .btn-mini-edit { background: #74b9ff; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        
        .child-item { display: flex; justify-content: space-between; align-items: center; padding: 12px; border-bottom: 1px solid #eee; }
        .child-active { background-color: #e8f7f0; border-left: 4px solid #00b894; }
        
        .btn-backup { background: #6c5ce7; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }
        .btn-restore { background: #e17055; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }

        /* Settings Modal */
        #settingsModal {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.8); z-index: 200; display: none;
            overflow-y: auto;
        }
        .settings-content {
            background: #fff; margin: 20px auto; padding: 25px; width: 90%; max-width: 500px;
            border-radius: 15px; position: relative;
        }
        .settings-group { margin-bottom: 20px; border-bottom: 1px solid #eee; padding-bottom: 15px; }
        .settings-group h4 { margin-top: 0; color: #2d3436; }
        .settings-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; display: block; }
        .close-settings { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin-top:0; color:#4a90e2;">å¥½å­©å­çå‹µ App</h2>
        <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">è«‹ç™»å…¥æˆ–è¨»å†Šä»¥åŒæ­¥é›²ç«¯è³‡æ–™</p>
        <input type="email" id="emailInput" class="login-input" placeholder="é›»å­ä¿¡ç®± (Email)">
        <input type="password" id="passwordInput" class="login-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        <div class="btn-group-login">
            <button id="btnLogin" class="btn-login">ç™»å…¥</button>
            <button id="btnRegister" class="btn-register">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </div>
        <button id="btnForgotPassword" class="btn-forgot">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
        <button id="btnGuest" class="btn-guest">ğŸ‘» æˆ‘æ˜¯éŠå®¢ (å…ç™»å…¥è©¦ç©)</button>
        <div id="loadingMsg">è³‡æ–™è®€å–ä¸­...</div>
        <p id="loginError"></p>
    </div>
</div>

<div id="settingsModal">
    <div class="settings-content">
        <span class="close-settings" onclick="closeSettings()">Ã—</span>
        <h2 style="margin-top:0; color:#4a90e2;">âš™ï¸ å…¨åŸŸè¨­å®š</h2>
        
        <div class="settings-group">
            <h4>ğŸ¦ éŠ€è¡Œåƒæ•¸è¨­å®š</h4>
            <label class="settings-label">æ´»å­˜æ—¥åˆ©ç‡ (ä¾‹å¦‚ 0.04 ä»£è¡¨ 4%)</label>
            <input type="number" id="setDailyRate" class="admin-input" step="0.01">
            <label class="settings-label">å®šå­˜æ—¥åˆ©ç‡ (ä¾‹å¦‚ 0.07 ä»£è¡¨ 7%)</label>
            <input type="number" id="setFixedRate" class="admin-input" step="0.01">
            <label class="settings-label">å®šå­˜é–å®šå¤©æ•¸ (å¤©)</label>
            <input type="number" id="setFixedDays" class="admin-input">
        </div>

        <div class="settings-group">
            <h4>ğŸ² æŠ½å¡æ©Ÿç‡è¨­å®š (%)</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                <div><small>æ™®é€š</small><input type="number" id="prob0" class="admin-input"></div>
                <div><small>ç½•è¦‹</small><input type="number" id="prob1" class="admin-input"></div>
                <div><small>ç¨€æœ‰</small><input type="number" id="prob2" class="admin-input"></div>
                <div><small>å²è©©</small><input type="number" id="prob3" class="admin-input"></div>
                <div><small>å‚³å¥‡</small><input type="number" id="prob4" class="admin-input"></div>
                <div><small>ç¥è©±</small><input type="number" id="prob5" class="admin-input"></div>
            </div>
            <p style="color:#d63031; font-size:0.8rem;">* è«‹ç¢ºä¿ç¸½å’Œç‚º 100</p>
        </div>

        <div class="settings-group">
            <h4>ğŸ çå“å…§å®¹ç®¡ç†</h4>
            <select id="tierSelect" class="admin-input" onchange="renderPrizeManager()" style="font-weight:bold; color:#333;">
                <option value="0">æ™®é€š</option>
                <option value="1">ç½•è¦‹</option>
                <option value="2">ç¨€æœ‰</option>
                <option value="3">å²è©©</option>
                <option value="4">å‚³å¥‡</option>
                <option value="5">ç¥è©±</option>
            </select>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="newPrizeName" class="admin-input" style="margin:0;" placeholder="è¼¸å…¥æ–°çå“åç¨±">
                <button class="btn-admin" style="width:80px; background:#00b894;" onclick="addCustomPrize()">æ–°å¢</button>
            </div>
            <div id="prizeManagerList" style="max-height: 150px; overflow-y: auto; background:#f9f9f9; border:1px solid #eee; border-radius:5px;"></div>
            <div style="text-align:right; margin-top:5px;">
                 <button onclick="restoreDefaultPrizes()" style="font-size:0.8rem; color:#999; background:none; border:none; cursor:pointer; text-decoration:underline;">â†º æ¢å¾©é è¨­çå“</button>
            </div>
        </div>

        <div id="guestBindSection" class="settings-group" style="display:none; background:#fff3cd; padding:10px; border-radius:8px;">
            <h4 style="color:#d35400;">ğŸ”— éŠå®¢è½‰æ­£ (ç¶å®š Email)</h4>
            <input type="email" id="bindEmail" class="admin-input" placeholder="è¨­å®š Email">
            <input type="password" id="bindPass" class="admin-input" placeholder="è¨­å®šå¯†ç¢¼">
            <button class="btn-admin" onclick="bindGuestAccount()">ç¢ºèªç¶å®šä¸¦ä¸Šå‚³è³‡æ–™</button>
        </div>

        <button class="btn-admin" onclick="saveSettings()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®š</button>
    </div>
</div>

<canvas id="confetti-canvas"></canvas>

<div class="user-bar">
    <span id="userEmail">æœªç™»å…¥</span>
    <button class="btn-logout" id="btnLogout">ç™»å‡º</button>
</div>

<div class="header">
    <div class="child-switcher-container">
        <div id="childSwitcher" class="child-switcher" onclick="toggleChildDropdown()">è®€å–ä¸­... â–¼</div>
        <div id="childDropdown" class="dropdown-menu"></div>
    </div>
    <div class="points-label">ç›®å‰æŒæœ‰çå‹µé»æ•¸</div>
    <div class="points-val" id="scoreDisplay">--</div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('tab-gacha')">ğŸ° æŠ½ç</button>
    <button class="nav-btn" onclick="switchTab('tab-bag')">ğŸ’ èƒŒåŒ…</button>
    <button class="nav-btn" onclick="switchTab('tab-bank')">ğŸ¦ éŠ€è¡Œ</button>
    <button class="nav-btn" onclick="switchTab('tab-admin')">âš™ï¸ å®¶é•·</button>
</div>

<div id="tab-gacha" class="section active">
    <div class="roulette-container">
        <div id="box-0" class="roulette-box box-common">æ™®é€š<span id="label-prob0">60%</span></div>
        <div id="box-1" class="roulette-box box-uncommon">ç½•è¦‹<span id="label-prob1">20%</span></div>
        <div id="box-2" class="roulette-box box-rare">ç¨€æœ‰<span id="label-prob2">10%</span></div>
        <div id="box-3" class="roulette-box box-epic">å²è©©<span id="label-prob3">6%</span></div>
        <div id="box-4" class="roulette-box box-legendary">å‚³å¥‡<span id="label-prob4">3%</span></div>
        <div id="box-5" class="roulette-box box-mythic">ç¥è©±<span id="label-prob5">1%</span></div>
    </div>
    <button id="btnDraw" class="big-btn" onclick="startGacha()">å•Ÿå‹•è½‰ç›¤ (-100é»)</button>
    <div class="pity-info">
        ğŸ›¡ï¸ <strong>ä¿åº•é€²åº¦ï¼š</strong><br>
        å°ä¿åº•(ç¨€æœ‰+)ï¼š<span id="pityRareDisp" style="color:#0984e3; font-weight:bold;">0</span>/10<br>
        å¤§ä¿åº•(ç¥è©±!)ï¼š<span id="pityLegDisp" style="color:#d63031; font-weight:bold;">0</span>/100
    </div>
    <div id="finalResult"><span style="color:#aaa">æº–å‚™æŠ½ç...</span></div>
</div>

<div id="tab-bag" class="section">
    <h3 style="border-left: 4px solid var(--rare); padding-left: 10px; color:#333;">ğŸ’ æˆ‘çš„çå“</h3>
    <div id="bagList"></div>
    <div id="bagEmpty" style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ç©ºç©ºçš„</div>
</div>

<div id="tab-bank" class="section">
    <div class="bank-card">
        <div class="bank-rate">ğŸ“ˆ æ´»å­˜åˆ©ç‡ï¼š<span id="dispDailyRate">4%</span> / å¤©</div>
        <div class="bank-desc">æ¯æ™š <strong>20:00</strong> çµç®—ï¼Œè¨˜å¾—ä¾†é ˜åˆ©æ¯ï¼</div>
        <div style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:5px; border-radius:5px;">
            ä¸Šæ¬¡é ˜æ¯ï¼š<span id="lastInterestDate">ç„¡</span>
        </div>
        <div style="text-align:center; margin-top:10px;">
             <div style="font-size:0.8rem; margin-bottom:5px; color:#eee;">è·é›¢ä¸‹æ¬¡ç™¼åˆ©æ¯é‚„æœ‰ï¼š</div>
             <div id="interestTimer" class="bank-timer">--:--:--</div>
        </div>
    </div>

    <div class="deposit-form">
        <h3 style="margin-top:0; color:#2d3436;">ğŸ”’ ç”³è«‹è¶…ç´šå®šå­˜</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
            é–å®š <strong><span id="dispFixedDays">30</span> å¤©</strong>ï¼Œæ¯å¤©ç²åˆ© <strong><span id="dispFixedRate">7%</span></strong>ï¼<br>
            <span style="color:#d63031;">(è¶…é«˜å ±é…¬ï¼Œä½†æœŸé–“çµ•å°ä¸èƒ½é ˜å‡º)</span>
        </p>
        <input type="number" id="depositAmount" class="deposit-input" placeholder="è¼¸å…¥è¦å­˜çš„é»æ•¸">
        <button class="btn-deposit" onclick="createDeposit()">ç¢ºèªå­˜å…¥</button>
    </div>

    <h3 style="margin:20px 0 10px 0;">æˆ‘çš„å®šå­˜å–®</h3>
    <div id="depositList"></div>
    <div id="depositEmpty" style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰å®šå­˜</div>
</div>

<div id="tab-admin" class="section">
    <div class="admin-box" style="border: 2px solid #0984e3;">
        <h3 style="color:#0984e3;">ğŸ‘¶ å°å­©ç®¡ç†</h3>
        <div id="childrenList"></div>
        <div style="margin-top:10px; display:flex; gap:5px;">
            <input id="newChildName" class="admin-input" style="margin:0;" placeholder="è¼¸å…¥æ–°å°å­©åå­—">
            <button class="btn-admin" style="width:80px;" onclick="addNewChild()">æ–°å¢</button>
        </div>
    </div>

    <div class="admin-box">
        <h3>ğŸ’° ç™¼æ”¾é»æ•¸</h3>
        <input type="text" id="reasonIn" class="admin-input" placeholder="åŸå› ">
        <input type="number" id="pointsIn" class="admin-input" placeholder="é»æ•¸">
        <button class="btn-admin" onclick="addPoints()">ç™¼æ”¾</button>
    </div>

    <button class="btn-settings" onclick="openSettings()">âš™ï¸ é€²å…¥è©³ç´°è¨­å®š (æ©Ÿç‡/åˆ©ç‡/çå“)</button>

    <div class="admin-box" style="background:#f0f3ff; border:1px solid #dbe4ff; margin-top:20px;">
        <h3 style="color:#4a69bd;">ğŸ’¾ è³‡æ–™å‚™ä»½ (æœ¬åœ°ç«¯)</h3>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-backup" onclick="exportData()">â¬‡ï¸ åŒ¯å‡º</button>
            <button class="btn-restore" onclick="document.getElementById('importFile').click()">â¬†ï¸ åŒ¯å…¥</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
        </div>
    </div>

    <div class="admin-box">
        <h3>ğŸ“œ å­˜æ‘ºç´€éŒ„</h3>
        <div id="historyList" style="font-size:0.9rem; color:#666;"></div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="resetAll()" style="background:#ddd; border:none; padding:10px 20px; border-radius:20px; color:#666;">âš ï¸ é‡ç½®è³‡æ–™ (æ¸…ç©ºé›²ç«¯)</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === æ‚¨çš„ Firebase è¨­å®š ===
    const firebaseConfig = {
      apiKey: "AIzaSyCArCzhRG6H-07Ooet34ikyP3w9xVq6t1U",
      authDomain: "kidrewardapp.firebaseapp.com",
      projectId: "kidrewardapp",
      storageBucket: "kidrewardapp.firebasestorage.app",
      messagingSenderId: "980449979485",
      appId: "1:980449979485:web:652d6b419385e76ad071b4",
      measurementId: "G-L86Y9Y477Y"
    };

    let app, auth, db, userRef, analytics;
    let currentUser = null;
    let isGuest = false;

    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase Init Error:", e);
        document.getElementById('loginError').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š";
    }

    const loginOverlay = document.getElementById('loginOverlay');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnForgotPassword = document.getElementById('btnForgotPassword');
    const btnGuest = document.getElementById('btnGuest');
    const btnLogout = document.getElementById('btnLogout');
    const loadingMsg = document.getElementById('loadingMsg');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const errorMsg = document.getElementById('loginError');

    function handleAuthError(error) {
        loadingMsg.style.display = 'none';
        let msg = error.code;
        if (msg === 'auth/invalid-email') msg = "Email æ ¼å¼ä¸æ­£ç¢º";
        else if (msg === 'auth/user-not-found' || msg === 'auth/wrong-password' || msg === 'auth/invalid-credential') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        else if (msg === 'auth/email-already-in-use') msg = "æ­¤ Email å·²ç¶“è¨»å†Šéäº†";
        else if (msg === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼± (è‡³å°‘éœ€6ä½)";
        errorMsg.innerText = msg;
    }

    btnLogin.addEventListener('click', () => {
        const email = emailInput.value; const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        signInWithEmailAndPassword(auth, email, password).catch((error) => { handleAuthError(error); });
    });

    btnRegister.addEventListener('click', () => {
        const email = emailInput.value; const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        createUserWithEmailAndPassword(auth, email, password).then(() => { alert("è¨»å†ŠæˆåŠŸï¼å·²ç‚ºæ‚¨ç™»å…¥"); }).catch((error) => { handleAuthError(error); });
    });

    btnForgotPassword.addEventListener('click', () => {
        const email = emailInput.value;
        if(!email) { errorMsg.innerText = "è«‹è¼¸å…¥ Email å¾Œå†æŒ‰å¿˜è¨˜å¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        sendPasswordResetEmail(auth, email).then(() => { loadingMsg.style.display = 'none'; alert("é‡è¨­ä¿¡å·²å¯„å‡ºï¼"); }).catch((error) => { handleAuthError(error); });
    });

    btnGuest.addEventListener('click', () => {
        isGuest = true;
        currentUser = { uid: 'guest', email: 'éŠå®¢æ¨¡å¼ (è³‡æ–™åƒ…å­˜æœ¬æ©Ÿ)' };
        document.getElementById('userEmail').innerText = currentUser.email;
        loginOverlay.style.display = 'none';
        loadDataFromLocal();
        setInterval(updateTimerAndDeposits, 1000);
    });

    btnLogout.addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { 
            if(isGuest) location.reload();
            else signOut(auth).then(() => { location.reload(); }); 
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            isGuest = false; currentUser = user;
            userRef = doc(db, "users", user.uid);
            document.getElementById('userEmail').innerText = user.email;
            loginOverlay.style.display = 'none';
            await loadDataFromCloud();
            setInterval(updateTimerAndDeposits, 1000);
        } else if(!isGuest) {
            loginOverlay.style.display = 'flex';
            loadingMsg.style.display = 'none';
        }
    });

    // === æ ¸å¿ƒè³‡æ–™çµæ§‹ ===
    const INTEREST_HOUR = 20;              
    const COST = 100;

    const DEFAULT_TIERS = [
        { id: 'common', index: 0, name: 'æ™®é€š', color: '#95a5a6', chance: 60, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸€è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 5åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•5åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“5åˆ†é˜'] },
        { id: 'uncommon', index: 1, name: 'ç½•è¦‹', color: '#00b894', chance: 20, rewards: ['å°æ—¥è¨˜æ¸›å°‘äºŒè¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•10åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“10åˆ†é˜'] },
        { id: 'rare', index: 2, name: 'ç¨€æœ‰', color: '#0984e3', chance: 10, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸‰è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 15åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“15åˆ†é˜', 'åª½åª½é™ªç¡è¦º'] },
        { id: 'epic', index: 3, name: 'å²è©©', color: '#6c5ce7', chance: 6, rewards: ['å°æ—¥è¨˜æ¸›å°‘å››è¡Œ', 'å¹³æ—¥å¯ç©é›»å‹•10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'å¢åŠ é»æ•¸200é»'] },
        { id: 'legendary', index: 4, name: 'å‚³å¥‡', color: '#e17055', chance: 3, rewards: ['å¹³æ—¥å¯ç©é›»å‹•15åˆ†é˜', 'é›¶ç”¨éŒ¢100å…ƒ', 'å¢åŠ é»æ•¸300é»'] },
        { id: 'mythic', index: 5, name: 'ç¥è©±', color: '#d63031', chance: 1, rewards: ['å¹³æ—¥å¯ç©é›»å‹•30åˆ†é˜', 'å¯ä»»æ„é¸è³¼500å…ƒå…§çš„å°ç¦®ç‰©', 'æ‰“æ‰‹å¿ƒè™•ç½°æ¸›å…ä¸€æ¬¡', 'å¢åŠ é»æ•¸500é»'] }
    ];

    // Master Data
    let masterData = {
        currentIdx: 0,
        settings: {
            dailyInterest: 0.04,
            fixedDepositRate: 0.07,
            fixedDepositDays: 30
        },
        tiers: JSON.parse(JSON.stringify(DEFAULT_TIERS)),
        children: [] 
    };

    // æŒ‡å‘ç•¶å‰å°å­©
    let data = null; 

    function createNewChildData() {
        return { score: 0, bag: [], history: [], pityRare: 0, pityLegendary: 0, lastLoginDate: "", deposits: [] };
    }

    function initMasterData(cloudData) {
        if (cloudData && cloudData.children) {
            masterData = cloudData;
            // ç¢ºä¿è¨­å®šæ¬„ä½å­˜åœ¨
            if(!masterData.settings) masterData.settings = { dailyInterest: 0.04, fixedDepositRate: 0.07, fixedDepositDays: 30 };
        } else if (cloudData && cloudData.score !== undefined) {
            console.log("èˆŠç‰ˆè³‡æ–™å‡ç´šä¸­...");
            let oldData = { ...cloudData }; delete oldData.tiers;
            masterData.tiers = cloudData.tiers || JSON.parse(JSON.stringify(DEFAULT_TIERS));
            masterData.settings = { dailyInterest: 0.04, fixedDepositRate: 0.07, fixedDepositDays: 30 };
            masterData.children = [{ name: "å¯¶è²1", data: oldData }];
            masterData.currentIdx = 0;
        } else {
            masterData.children = [{ name: "å¯¶è²1", data: createNewChildData() }];
            masterData.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS));
            masterData.settings = { dailyInterest: 0.04, fixedDepositRate: 0.07, fixedDepositDays: 30 };
            masterData.currentIdx = 0;
        }
        switchChild(masterData.currentIdx);
    }

    async function loadDataFromCloud() {
        try {
            const docSnap = await getDoc(userRef);
            initMasterData(docSnap.exists() ? docSnap.data() : null);
            saveData();
        } catch (e) { console.error(e); alert("è®€å–å¤±æ•—ï¼š" + e.message); }
    }

    function loadDataFromLocal() {
        const saved = localStorage.getItem('kidGacha_guest_v20');
        initMasterData(saved ? JSON.parse(saved) : null);
    }

    function saveData() {
        if (isGuest) { localStorage.setItem('kidGacha_guest_v20', JSON.stringify(masterData)); updateUI(); }
        else if (currentUser) { setDoc(userRef, masterData).then(() => updateUI()).catch(e => console.error(e)); }
    }

    // === å°å­©åˆ‡æ› & è¨­å®š ===
    window.toggleChildDropdown = function() {
        document.getElementById("childDropdown").classList.toggle("show");
    }
    window.onclick = function(event) {
        if (!event.target.matches('.child-switcher')) {
            var dropdowns = document.getElementsByClassName("dropdown-menu");
            for (var i = 0; i < dropdowns.length; i++) {
                var openDropdown = dropdowns[i];
                if (openDropdown.classList.contains('show')) {
                    openDropdown.classList.remove('show');
                }
            }
        }
    }

    window.switchChild = function(idx) {
        if (idx < 0 || idx >= masterData.children.length) idx = 0;
        masterData.currentIdx = idx;
        data = masterData.children[idx].data;
        document.getElementById('childSwitcher').innerText = masterData.children[idx].name + " â–¼";
        
        // æ›´æ–°ä¸‹æ‹‰é¸å–®
        const dropdown = document.getElementById("childDropdown");
        dropdown.innerHTML = masterData.children.map((c, i) => 
            `<div onclick="switchChild(${i})">${c.name} ${i === masterData.currentIdx ? 'âœ”' : ''}</div>`
        ).join('');

        checkDailyInterest();
        updateUI();
        renderPrizeManager();
        renderChildrenList();
    }

    window.addNewChild = function() {
        const name = document.getElementById('newChildName').value;
        if (!name) return alert("è«‹è¼¸å…¥åå­—");
        masterData.children.push({ name: name, data: createNewChildData() });
        document.getElementById('newChildName').value = '';
        saveData();
        switchChild(masterData.children.length - 1);
    }

    window.renameChild = function(idx) {
        const newName = prompt("è«‹è¼¸å…¥æ–°åå­—", masterData.children[idx].name);
        if (newName) { masterData.children[idx].name = newName; saveData(); switchChild(masterData.currentIdx); }
    }

    window.deleteChild = function(idx) {
        if (masterData.children.length <= 1) return alert("è‡³å°‘è¦ä¿ç•™ä¸€å€‹å°å­©");
        if (confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${masterData.children[idx].name}ã€çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿç„¡æ³•å¾©åŸï¼`)) {
            masterData.children.splice(idx, 1);
            switchChild(0);
            saveData();
        }
    }

    function renderChildrenList() {
        const list = document.getElementById('childrenList');
        list.innerHTML = masterData.children.map((c, i) => `
            <div class="child-item ${i === masterData.currentIdx ? 'child-active' : ''}">
                <span onclick="switchChild(${i})" style="cursor:pointer; flex:1; font-weight:bold;">${c.name}</span>
                <div>
                    <button class="btn-mini-edit" onclick="renameChild(${i})">âœï¸</button>
                    <button class="btn-mini-del" onclick="deleteChild(${i})">ğŸ—‘ï¸</button>
                </div>
            </div>
        `).join('');
    }

    // === è¨­å®šè¦–çª—é‚è¼¯ ===
    window.openSettings = function() {
        document.getElementById('settingsModal').style.display = 'block';
        document.getElementById('setDailyRate').value = masterData.settings.dailyInterest;
        document.getElementById('setFixedRate').value = masterData.settings.fixedDepositRate;
        document.getElementById('setFixedDays').value = masterData.settings.fixedDepositDays;
        
        // å¡«å…¥æ©Ÿç‡
        masterData.tiers.forEach((t, i) => {
            document.getElementById(`prob${i}`).value = t.chance;
        });

        // éŠå®¢ç¶å®šé¡¯ç¤º
        document.getElementById('guestBindSection').style.display = isGuest ? 'block' : 'none';
        
        renderPrizeManager();
    }

    window.closeSettings = function() {
        document.getElementById('settingsModal').style.display = 'none';
    }

    window.saveSettings = function() {
        const dRate = parseFloat(document.getElementById('setDailyRate').value);
        const fRate = parseFloat(document.getElementById('setFixedRate').value);
        const fDays = parseInt(document.getElementById('setFixedDays').value);
        
        // é©—è­‰æ©Ÿç‡ç¸½å’Œ
        let totalProb = 0;
        let newProbs = [];
        for(let i=0; i<6; i++) {
            let p = parseFloat(document.getElementById(`prob${i}`).value);
            if(isNaN(p) || p < 0) return alert("æ©Ÿç‡å¿…é ˆæ˜¯æ­£æ•¸");
            newProbs.push(p);
            totalProb += p;
        }
        if(Math.abs(totalProb - 100) > 0.1) return alert(`ç›®å‰æ©Ÿç‡ç¸½å’Œç‚º ${totalProb}%ï¼Œå¿…é ˆç­‰æ–¼ 100%`);

        masterData.settings.dailyInterest = dRate;
        masterData.settings.fixedDepositRate = fRate;
        masterData.settings.fixedDepositDays = fDays;
        
        // æ›´æ–°æ©Ÿç‡
        newProbs.forEach((p, i) => masterData.tiers[i].chance = p);

        saveData();
        updateUI(); // æ›´æ–°é¡¯ç¤ºçš„åˆ©ç‡
        closeSettings();
        alert("è¨­å®šå·²å„²å­˜ï¼");
    }

    window.bindGuestAccount = function() {
        const email = document.getElementById('bindEmail').value;
        const pass = document.getElementById('bindPass').value;
        if(!email || !pass) return alert("è«‹è¼¸å…¥å®Œæ•´è³‡æ–™");
        
        loadingMsg.style.display = 'block';
        createUserWithEmailAndPassword(auth, email, pass).then((cred) => {
            isGuest = false;
            currentUser = cred.user;
            userRef = doc(db, "users", currentUser.uid);
            saveData(); // æŠŠç›®å‰çš„ masterData å­˜ä¸Šå»
            alert("ç¶å®šæˆåŠŸï¼è³‡æ–™å·²ä¸Šå‚³é›²ç«¯");
            location.reload();
        }).catch(e => alert("ç¶å®šå¤±æ•—: " + e.message));
    }

    // === æ ¸å¿ƒåŠŸèƒ½ ===
    window.switchTab = function(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const buttons = document.querySelectorAll('.nav-btn');
        if(id==='tab-gacha') buttons[0].classList.add('active');
        if(id==='tab-bag') buttons[1].classList.add('active');
        if(id==='tab-bank') buttons[2].classList.add('active');
        if(id==='tab-admin') { buttons[3].classList.add('active'); renderChildrenList(); }
    };

    window.startGacha = function() {
        if (data.score < COST) return;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f,t,d){let o=audioCtx.createOscillator();let g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}
        
        data.score -= COST; 
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: 'åƒåŠ æŠ½ç', amount: -COST });

        // è¨ˆç®—æ©Ÿç‡
        let rand = Math.random() * 100;
        let cumulative = 0;
        let resultTier = masterData.tiers[0];
        
        // ä¿åº•é‚è¼¯
        if (data.pityLegendary >= 99) resultTier = masterData.tiers[5];
        else if (data.pityRare >= 9) resultTier = masterData.tiers[2];
        else {
            for (let t of masterData.tiers) {
                cumulative += t.chance;
                if (rand <= cumulative) { resultTier = t; break; }
            }
        }

        if (resultTier.index === 5) { data.pityLegendary = 0; data.pityRare = 0; }
        else if (resultTier.index >= 2) { data.pityRare = 0; data.pityLegendary++; }
        else { data.pityRare++; data.pityLegendary++; }
        
        saveData();
        
        const btnDraw = document.getElementById('btnDraw');
        const finalResult = document.getElementById('finalResult');
        btnDraw.disabled = true;
        finalResult.innerHTML = '<span style="color:#999; font-size:1.5rem">ğŸ° è½‰å‹•ä¸­...</span>';
        
        let currentIdx = 0; const totalLoops = 5; 
        const boxes = document.querySelectorAll('.roulette-box');
        let speed = 40; let stepCount = 0; let totalSteps = (totalLoops * 6) + resultTier.index; 
        
        function step() {
            boxes.forEach(b => b.classList.remove('active'));
            document.getElementById(`box-${currentIdx}`).classList.add('active');
            playBeep(800, 'square', 0.03);
            if (stepCount >= totalSteps) {
                playBeep(600, 'sine', 0.1); 
                let finalReward = "éŠ˜è¬æƒ é¡§";
                if (resultTier.rewards && resultTier.rewards.length > 0) {
                    finalReward = resultTier.rewards[Math.floor(Math.random() * resultTier.rewards.length)];
                }
                finalResult.innerHTML = `<h2 style="color:${resultTier.color}">${resultTier.name}ç´šçå‹µï¼</h2><p style="font-weight:bold; font-size:1.3rem; color:#333;">${finalReward}</p>`;
                data.bag.unshift({ tierName: resultTier.name, color: resultTier.color, reward: finalReward, id: Date.now() });
                saveData();
                btnDraw.disabled = false; updateUI();
                if (resultTier.index >= 2) fireConfetti();
                return;
            }
            stepCount++; currentIdx++; if (currentIdx >= 6) currentIdx = 0;
            let remainingSteps = totalSteps - stepCount;
            if (remainingSteps < 8) speed += (10 - remainingSteps) * 20; else if (speed > 40) speed = 40;
            setTimeout(step, speed);
        }
        step();
    };

    window.useItem = function(idx) {
        const item = data.bag[idx];
        if(!confirm(`ç¢ºå®šä½¿ç”¨ã€Œ${item.reward}ã€å—ï¼Ÿ`)) return;
        const match = item.reward.match(/å¢åŠ é»æ•¸(\d+)é»/);
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        
        if (match) {
            const p = parseInt(match[1]); data.score += p;
            data.history.push({ date: d, reason: `ä½¿ç”¨é»æ•¸å¡: ${item.reward}`, amount: p });
            alert(`ğŸŠ å·²å¢åŠ  ${p} é»ï¼`);
        } else {
            data.history.push({ date: d, reason: `ä½¿ç”¨: ${item.reward}`, amount: 0 });
        }
        data.bag.splice(idx, 1);
        saveData();
    };

    window.addPoints = function() {
        const r = document.getElementById('reasonIn').value;
        const p = parseInt(document.getElementById('pointsIn').value);
        if (!r || !p) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        data.score += p; 
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: r, amount: p });
        saveData(); alert(`å·²ç™¼æ”¾ ${p} é»`); document.getElementById('reasonIn').value = '';
    };

    window.createDeposit = function() {
        const amount = parseInt(document.getElementById('depositAmount').value);
        if (!amount || amount <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
        if (amount > data.score) return alert("é»æ•¸ä¸è¶³ï¼");
        
        const rate = masterData.settings.fixedDepositRate;
        const days = masterData.settings.fixedDepositDays;
        const estimatedProfit = Math.floor(amount * rate * days);
        const totalReturn = amount + estimatedProfit;

        if(!confirm(`ç¢ºå®šè¦å°‡ ${amount} é»å­˜å…¥å®šå­˜å—ï¼Ÿ\n\nğŸ“… é–å®š ${days} å¤©\nğŸ“ˆ é è¨ˆç²åˆ© +${estimatedProfit} é»\nğŸ’° åˆ°æœŸå¯é ˜ ${totalReturn} é»`)) return;

        data.score -= amount;
        const now = new Date();
        const endDate = new Date(now);
        endDate.setDate(endDate.getDate() + days); 
        
        data.deposits.push({ id: Date.now(), amount: amount, startDate: now.toISOString(), endDate: endDate.toISOString(), status: 'active' });
        
        const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: `ğŸ¦ ç”³è«‹å®šå­˜`, amount: -amount });
        
        saveData();
        alert("å®šå­˜ç”³è«‹æˆåŠŸï¼");
        document.getElementById('depositAmount').value = "";
    };

    window.redeemDeposit = function(id) {
        const idx = data.deposits.findIndex(d => d.id === id); if (idx === -1) return;
        const deposit = data.deposits[idx];
        const principal = deposit.amount;
        const interest = Math.floor(principal * masterData.settings.fixedDepositRate * masterData.settings.fixedDepositDays);
        const total = principal + interest;
        
        data.score += total;
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: `ğŸ’° å®šå­˜åˆ°æœŸé ˜å›`, amount: total });
        
        data.deposits.splice(idx, 1);
        saveData();
        alert(`æ­å–œï¼å®šå­˜åˆ°æœŸï¼\næœ¬é‡‘ï¼š${principal}\nåˆ©æ¯ï¼š${interest}\nç¸½å…±ç²å¾—ï¼š${total} é»ï¼`);
    };

    window.resetAll = function() {
        if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ')) {
            masterData.children = [{ name: "å¯¶è²1", data: createNewChildData() }];
            masterData.currentIdx = 0;
            saveData();
            switchChild(0);
        }
    };

    window.renderPrizeManager = function() {
        const select = document.getElementById('tierSelect');
        const listDiv = document.getElementById('prizeManagerList');
        const selectedIndex = parseInt(select.value);
        const tierData = masterData.tiers[selectedIndex];
        select.style.borderColor = tierData.color;
        select.style.color = tierData.color;
        let html = '';
        if (tierData.rewards.length === 0) { html = '<div style="padding:10px; text-align:center; color:#999;">æ­¤ç­‰ç´šç›®å‰æ²’æœ‰çå“</div>'; } 
        else {
            tierData.rewards.forEach((reward, idx) => {
                html += `<div class="prize-manage-item"><span>${reward}</span><div><button class="btn-mini-edit" onclick="editPrize(${selectedIndex}, ${idx})">âœï¸</button><button class="btn-mini-del" onclick="removePrize(${selectedIndex}, ${idx})">ğŸ—‘ï¸</button></div></div>`;
            });
        }
        listDiv.innerHTML = html;
    };
    window.addCustomPrize = function() {
        const select = document.getElementById('tierSelect');
        const input = document.getElementById('newPrizeName');
        const name = input.value.trim();
        const tierIdx = parseInt(select.value);
        if (!name) return alert("è«‹è¼¸å…¥çå“åç¨±");
        masterData.tiers[tierIdx].rewards.push(name); saveData(); input.value = ''; renderPrizeManager();
    };
    window.removePrize = function(tierIdx, rewardIdx) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${masterData.tiers[tierIdx].rewards[rewardIdx]}ã€å—ï¼Ÿ`)) return;
        masterData.tiers[tierIdx].rewards.splice(rewardIdx, 1); saveData(); renderPrizeManager();
    };
    window.editPrize = function(tierIdx, rewardIdx) {
        const oldName = masterData.tiers[tierIdx].rewards[rewardIdx];
        const newName = prompt("ä¿®æ”¹çå“åç¨±ï¼š", oldName);
        if (newName && newName.trim() !== "") {
            masterData.tiers[tierIdx].rewards[rewardIdx] = newName.trim(); saveData(); renderPrizeManager();
        }
    };
    window.restoreDefaultPrizes = function() {
        if(confirm("âš ï¸ ç¢ºå®šè¦æ¢å¾©æˆã€Œé è¨­çå“ã€å—ï¼Ÿ")) {
            masterData.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS));
            // æ¢å¾©æ©Ÿç‡é¡¯ç¤º
            updateUI();
            saveData();
            renderPrizeManager();
            alert("å·²æ¢å¾©é è¨­å€¼ã€‚");
        }
    };

    window.updateTimerAndDeposits = function() {
        const now = new Date();
        let target = new Date(now); target.setHours(INTEREST_HOUR, 0, 0, 0);
        if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('interestTimer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        const list = document.getElementById('depositList');
        const empty = document.getElementById('depositEmpty');
        if (data.deposits.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        let html = '';
        data.deposits.forEach(d => {
            const end = new Date(d.endDate); const isMature = now >= end; const timeLeft = end - now;
            let timeStr = "";
            if (isMature) {
                timeStr = "âœ… å·²åˆ°æœŸï¼Œå¯é ˜å›";
            } else {
                const days = Math.floor(timeLeft / (1000 * 60 * 60 * 24));
                const hours = Math.floor((timeLeft % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
                const mins = Math.floor((timeLeft % (1000 * 60 * 60)) / (1000 * 60));
                timeStr = `â³ å‰©é¤˜ ${days}å¤© ${hours}æ™‚ ${mins}åˆ†`;
            }
            const profit = Math.floor(d.amount * masterData.settings.fixedDepositRate * masterData.settings.fixedDepositDays);
            html += `<div class="deposit-item"><div class="deposit-header"><span>æœ¬é‡‘: ${d.amount}</span><span style="color:#00b894; font-size:0.9rem;">(é æœŸ+${profit})</span></div><div class="deposit-time">${timeStr}</div><button class="btn-redeem" onclick="redeemDeposit(${d.id})" ${isMature ? '' : 'disabled'}>${isMature ? 'ğŸ’° ç«‹å³é ˜å–' : 'æœªåˆ°æœŸ'}</button></div>`;
        });
        list.innerHTML = html;
    };

    function checkDailyInterest() {
        const now = new Date(); const currentHour = now.getHours(); const todayStr = now.toDateString();
        if (currentHour < INTEREST_HOUR) return;
        if (data.lastLoginDate !== todayStr && data.score > 0) {
            const interest = Math.floor(data.score * masterData.settings.dailyInterest);
            if (interest > 0) {
                data.score += interest;
                const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
                data.history.push({ date: d, reason: `ğŸ’° å¤œé–“æ´»å­˜çµç®— (${(masterData.settings.dailyInterest*100).toFixed(0)}%)`, amount: interest });
                alert(`ğŸŒ™ æ™šä¸Šå¥½ï¼${masterData.children[masterData.currentIdx].name}\néŠ€è¡Œåˆ©æ¯å·²å…¥å¸³ï¼š+${interest} é»ï¼`);
            }
            data.lastLoginDate = todayStr; saveData();
        } else if (data.lastLoginDate === "") { data.lastLoginDate = todayStr; saveData(); }
    }

    function updateUI() {
        document.getElementById('scoreDisplay').innerText = data.score;
        document.getElementById('lastInterestDate').innerText = data.lastLoginDate || "ç„¡";
        
        // æ›´æ–°é¡¯ç¤ºçš„åˆ©ç‡
        document.getElementById('dispDailyRate').innerText = (masterData.settings.dailyInterest * 100) + '%';
        document.getElementById('dispFixedRate').innerText = (masterData.settings.fixedDepositRate * 100) + '%';
        document.getElementById('dispFixedDays').innerText = masterData.settings.fixedDepositDays;

        // æ›´æ–°è½‰ç›¤ä¸Šçš„æ©Ÿç‡é¡¯ç¤º
        masterData.tiers.forEach((t, i) => {
            const el = document.getElementById(`label-prob${i}`);
            if(el) el.innerText = t.chance + "%";
        });

        const btn = document.getElementById('btnDraw');
        if (data.score < COST) { btn.innerText = `é»æ•¸ä¸è¶³ (ç¼º${COST - data.score})`; btn.disabled = true; } 
        else { btn.innerText = `å•Ÿå‹•è½‰ç›¤ (-${COST}é»)`; btn.disabled = false; }
        
        const bagList = document.getElementById('bagList'); bagList.innerHTML = '';
        if (data.bag.length === 0) document.getElementById('bagEmpty').style.display = 'block';
        else {
            document.getElementById('bagEmpty').style.display = 'none';
            data.bag.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = 'list-item'; div.style.borderLeftColor = item.color;
                div.innerHTML = `<div><small style="color:${item.color};font-weight:bold;">${item.tierName}</small><br><span>${item.reward}</span></div><button class="btn-use" onclick="useItem(${idx})">ä½¿ç”¨</button>`;
                bagList.appendChild(div);
            });
        }
        
        const histList = document.getElementById('historyList');
        histList.innerHTML = data.history.slice().reverse().map(h => `<div style="border-bottom:1px solid #eee; padding:8px 0;">${h.date} - ${h.reason} <span style="float:right; font-weight:bold; color:${h.amount>0?'#00b894':'#e17055'}">${h.amount}</span></div>`).join('');
        
        document.getElementById('pityRareDisp').innerText = data.pityRare;
        document.getElementById('pityLegDisp').innerText = data.pityLegendary;
        
        window.updateTimerAndDeposits();
    }

    function fireConfetti() { const c = document.getElementById('confetti-canvas'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; let p = []; const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71']; for(let i=0; i<150; i++) p.push({x: c.width/2, y: c.height/2, r: Math.random()*6+2, dx: Math.random()*10-5, dy: Math.random()*10-5, color: colors[Math.floor(Math.random()*colors.length)], life: 100}); function d() { ctx.clearRect(0,0,c.width,c.height); let active = false; p.forEach(k => { if(k.life>0){ active=true; ctx.beginPath(); ctx.arc(k.x, k.y, k.r, 0, Math.PI*2); ctx.fillStyle=k.color; ctx.fill(); k.x+=k.dx; k.y+=k.dy; k.dy+=0.2; k.life--; }}); if(active) requestAnimationFrame(d); else ctx.clearRect(0,0,c.width,c.height); } d(); }

    window.exportData = function() { const json = JSON.stringify(masterData); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([json], {type: "application/json"})); a.download = `reward_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    window.importData = function(input) { const file = input.files[0]; if (!file || !confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥æ–°æª”æ¡ˆå°‡æœƒã€Œè¦†è“‹ã€ç›®å‰çš„é›²ç«¯ç´€éŒ„ï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return; const reader = new FileReader(); reader.onload = function(e) { try { const imported = JSON.parse(e.target.result); if (imported.children) { masterData = imported; } else { masterData.children = [{name:"å¯¶è²1", data:imported}]; masterData.currentIdx=0; if(imported.tiers) masterData.tiers=imported.tiers; } saveData(); alert("âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼"); switchChild(0); } catch(err) { alert("âŒ æ ¼å¼éŒ¯èª¤"); } }; reader.readAsText(file); input.value = ''; }
</script>
</body>
</html>