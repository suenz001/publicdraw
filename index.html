<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šå¹¸é‹æŠ½æŠ½æ¨‚ - ä½œè€…æ¨å»£ç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --header-bg: #ffffff;
            --text-color: #333333;
            --primary: #4a90e2;
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            
            --common: #95a5a6; --uncommon: #00b894; --rare: #0984e3;
            --epic: #6c5ce7; --legendary: #e17055; --mythic: #d63031;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            margin: 0; padding: 0;
            user-select: none; -webkit-user-select: none;
            overflow-x: hidden; padding-bottom: 60px;
        }

        /* === ç™»å…¥ä»‹é¢ === */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .login-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 85%; max-width: 350px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; font-size: 1rem;
        }
        .btn-group-login { display: flex; gap: 10px; margin-top: 15px; }
        .btn-login { flex: 1; background: #4a90e2; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-register { flex: 1; background: #00b894; color: white; border: none; padding: 12px; font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-guest { background: #b2bec3; color: white; border: none; padding: 10px; font-size: 0.9rem; border-radius: 50px; cursor: pointer; margin-top: 20px; width: 100%; }
        .btn-forgot { background: none; border: none; color: #888; margin-top: 15px; font-size: 0.9rem; cursor: pointer; text-decoration: underline; }
        #loadingMsg { color: #888; margin-top: 10px; font-size: 0.9rem; display: none; }
        #loginError { color: red; font-size: 0.8rem; margin-top: 10px; min-height: 1.2em; }

        .user-bar { background: #2d3436; color: white; padding: 8px 15px; display: flex; justify-content: space-between; align-items: center; font-size: 0.85rem; }
        .btn-logout { background: #d63031; border: none; color: white; padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem; }

        /* === Header & Dropdown === */
        .header { background: var(--header-bg); padding: 15px; text-align: center; box-shadow: 0 2px 10px rgba(0,0,0,0.05); position: sticky; top: 0; z-index: 100; }
        .child-switcher-container { position: relative; display: inline-block; }
        .child-switcher { display: inline-block; background: #f1f2f6; padding: 5px 15px; border-radius: 20px; margin-bottom: 10px; font-weight: bold; color: #2d3436; cursor: pointer; border: 2px solid #dfe6e9; user-select: none; }
        .dropdown-menu { display: none; position: absolute; top: 100%; left: 50%; transform: translateX(-50%); background-color: white; min-width: 160px; box-shadow: 0 8px 16px rgba(0,0,0,0.2); z-index: 101; border-radius: 10px; overflow: hidden; margin-top: 5px; }
        .dropdown-menu div { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; border-bottom: 1px solid #f1f1f1; }
        .dropdown-menu div:hover { background-color: #f1f1f1; }
        .show { display: block; }
        .points-val { font-size: 3rem; font-weight: 800; color: #fab1a0; margin: 0; line-height: 1.2; }
        .points-label { font-size: 0.9rem; color: #888; font-weight: bold; }

        .nav { display: flex; background: white; margin: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); padding: 5px; }
        .nav-btn { flex: 1; padding: 10px; background: none; border: none; color: #888; font-weight: bold; cursor: pointer; border-radius: 8px; transition: all 0.2s; font-size: 0.9rem; }
        .nav-btn.active { background: #dfe6e9; color: #2d3436; }
        .section { display: none; padding: 10px 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }
        
        .roulette-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .roulette-box { background: #e9ecef; border-radius: 12px; padding: 20px 5px; text-align: center; font-weight: 800; font-size: 1.2rem; opacity: 0.6; color: #555; border: 3px solid transparent; border-bottom-width: 5px; display: flex; flex-direction: column; justify-content: center; min-height: 80px; }
        .roulette-box span { font-size: 0.8rem; font-weight: normal; margin-top: 5px; opacity: 0.8; }
        .roulette-box.active { opacity: 1; transform: scale(1.05); background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10; }
        
        .box-common { border-color: var(--common); } .box-common.active { color: var(--common); }
        .box-uncommon { border-color: var(--uncommon); } .box-uncommon.active { color: var(--uncommon); }
        .box-rare { border-color: var(--rare); } .box-rare.active { color: var(--rare); }
        .box-epic { border-color: var(--epic); } .box-epic.active { color: var(--epic); }
        .box-legendary { border-color: var(--legendary); } .box-legendary.active { color: var(--legendary); }
        .box-mythic { border-color: var(--mythic); } .box-mythic.active { color: var(--mythic); }

        .big-btn { width: 100%; padding: 18px; font-size: 1.4rem; font-weight: bold; border-radius: 50px; border: none; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); cursor: pointer; margin-top: 15px; }
        .big-btn:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; }
        #finalResult { margin-top: 25px; padding: 20px; border-radius: 15px; text-align: center; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        
        .list-item { background: white; border-left: 6px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-use { background: #ff7675; color: white; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }
        .pity-info { background: #fff8e1; color: #d35400; padding: 10px; border-radius: 10px; font-size: 0.85rem; margin-top: 20px; text-align: center; border: 1px solid #ffe0b2; }
        
        .bank-card { background: linear-gradient(135deg, #00b09b, #96c93d); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,176,155,0.3); }
        .bank-rate { font-size: 1.5rem; font-weight: bold; }
        .bank-desc { font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px; }
        .bank-timer { font-family: monospace; font-size: 1.1rem; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-top: 10px; display: inline-block; font-weight: bold;}
        
        .deposit-form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .deposit-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 1.2rem; box-sizing: border-box; text-align: center; }
        .btn-deposit { width: 100%; padding: 12px; background: #00b894; color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }
        .deposit-item { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .deposit-item::before { content: "ğŸ”’"; position: absolute; right: -10px; top: -10px; font-size: 3rem; opacity: 0.1; }
        .deposit-header { display: flex; justify-content: space-between; font-weight: bold; color: #2d3436; margin-bottom: 5px; }
        .deposit-time { font-size: 0.85rem; color: #636e72; }
        .btn-redeem { width: 100%; margin-top: 10px; padding: 8px; background: #fdcb6e; color: #d35400; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-redeem:disabled { background: #dfe6e9; color: #b2bec3; cursor: not-allowed; }
        
        .admin-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-admin { background: #0984e3; color: white; padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; }
        .btn-settings { background: #636e72; color: white; padding: 12px; width: 100%; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; font-size: 1.1rem; margin-top:10px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        
        .prize-manage-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .btn-mini-del { background: #ff7675; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; margin-left: 5px;}
        .btn-mini-edit { background: #74b9ff; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        
        .btn-backup { background: #6c5ce7; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }
        .btn-restore { background: #e17055; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }

        /* æ–°å¢ï¼šå¤–éƒ¨é€£çµæŒ‰éˆ•æ¨£å¼ */
        .btn-external-game { display: inline-block; background-color: #636e72; color: white; padding: 10px 20px; border-radius: 25px; text-decoration: none; font-size: 0.9rem; box-shadow: 0 2px 5px rgba(0,0,0,0.1); transition: transform 0.1s; }
        .btn-external-game:active { transform: scale(0.95); }

        /* Settings Modal */
        #settingsModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 200; display: none; overflow-y: auto; }
        .settings-content { background: #fff; margin: 20px auto; padding: 25px; width: 90%; max-width: 500px; border-radius: 15px; position: relative; }
        .settings-group { margin-bottom: 25px; border-bottom: 2px dashed #eee; padding-bottom: 20px; }
        .settings-group h4 { margin-top: 0; color: #2d3436; margin-bottom: 15px; border-left: 4px solid #4a90e2; padding-left: 10px; }
        .settings-label { font-size: 0.9rem; color: #666; margin-bottom: 5px; display: block; font-weight: bold; }
        .close-settings { position: absolute; top: 15px; right: 20px; font-size: 2rem; cursor: pointer; color: #999; line-height: 20px; }
        .radio-group { display: flex; gap: 15px; margin-bottom: 10px; }
        .radio-group label { display: flex; align-items: center; gap: 5px; cursor: pointer; }

        /* PIN Modal */
        #pinModal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.95); z-index: 300; display: none; flex-direction: column; justify-content: center; align-items: center; }
        .pin-display { font-size: 2rem; letter-spacing: 10px; margin-bottom: 20px; font-weight: bold; min-height: 40px; }
        .pin-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; }
        .pin-btn { width: 70px; height: 70px; border-radius: 50%; border: 2px solid #ddd; background: white; font-size: 1.5rem; font-weight: bold; cursor: pointer; color: #333; display: flex; justify-content: center; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .pin-btn:active { background: #f0f0f0; transform: scale(0.95); }
        
        /* Child Management List in Settings */
        .child-row { display: flex; justify-content: space-between; align-items: center; padding: 10px; background: #f8f9fa; margin-bottom: 5px; border-radius: 8px; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin-top:0; color:#4a90e2;">å¥½å­©å­çå‹µ App</h2>
        <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">è«‹ç™»å…¥æˆ–è¨»å†Šä»¥åŒæ­¥é›²ç«¯è³‡æ–™</p>
        <input type="email" id="emailInput" class="login-input" placeholder="é›»å­ä¿¡ç®± (Email)">
        <input type="password" id="passwordInput" class="login-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        <div class="btn-group-login">
            <button id="btnLogin" class="btn-login">ç™»å…¥</button>
            <button id="btnRegister" class="btn-register">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </div>
        <button id="btnForgotPassword" class="btn-forgot">å¿˜è¨˜å¯†ç¢¼ï¼Ÿ</button>
        <button id="btnGuest" class="btn-guest">ğŸ‘» æˆ‘æ˜¯éŠå®¢ (å…ç™»å…¥è©¦ç©)</button>
        <div id="loadingMsg">è³‡æ–™è®€å–ä¸­...</div>
        <p id="loginError"></p>
    </div>
</div>

<div id="pinModal">
    <h3 id="pinTitle" style="color:#2d3436;">è«‹è¼¸å…¥å®¶é•·å¯†ç¢¼</h3>
    <div id="pinDisplay" class="pin-display"></div>
    <div class="pin-grid">
        <div class="pin-btn" onclick="enterPin(1)">1</div>
        <div class="pin-btn" onclick="enterPin(2)">2</div>
        <div class="pin-btn" onclick="enterPin(3)">3</div>
        <div class="pin-btn" onclick="enterPin(4)">4</div>
        <div class="pin-btn" onclick="enterPin(5)">5</div>
        <div class="pin-btn" onclick="enterPin(6)">6</div>
        <div class="pin-btn" onclick="enterPin(7)">7</div>
        <div class="pin-btn" onclick="enterPin(8)">8</div>
        <div class="pin-btn" onclick="enterPin(9)">9</div>
        <div class="pin-btn" style="background:#ff7675; color:white; font-size:1rem;" onclick="closePin()">å–æ¶ˆ</div>
        <div class="pin-btn" onclick="enterPin(0)">0</div>
        <div class="pin-btn" style="background:#dfe6e9; font-size:1rem;" onclick="clearPin()">â†</div>
    </div>
</div>

<div id="settingsModal">
    <div class="settings-content">
        <span class="close-settings" onclick="closeSettings()">Ã—</span>
        <h2 style="margin-top:0; color:#4a90e2;">âš™ï¸ è©³ç´°è¨­å®š</h2>
        
        <div class="settings-group">
            <h4>ğŸ¦ éŠ€è¡Œåƒæ•¸</h4>
            <label class="settings-label">æ´»å­˜æ—¥åˆ©ç‡ (ä¾‹å¦‚ 0.04 ä»£è¡¨ 4%)</label>
            <input type="number" id="setDailyRate" class="admin-input" step="0.01">
            <label class="settings-label">æ´»å­˜ç™¼æ”¾æ™‚é–“ (24å°æ™‚åˆ¶ï¼Œ0~23)</label>
            <input type="number" id="setInterestHour" class="admin-input" placeholder="é è¨­ 20" min="0" max="23">
            <label class="settings-label">å®šå­˜æ—¥åˆ©ç‡ (ä¾‹å¦‚ 0.07 ä»£è¡¨ 7%)</label>
            <input type="number" id="setFixedRate" class="admin-input" step="0.01">
            <label class="settings-label">å®šå­˜é–å®šå¤©æ•¸ (å¤©)</label>
            <input type="number" id="setFixedDays" class="admin-input">
        </div>

        <div class="settings-group">
            <h4>ğŸ² æ©Ÿç‡èˆ‡ä¿åº•</h4>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:10px;">
                <div><small>æ™®é€š(%)</small><input type="number" id="prob0" class="admin-input"></div>
                <div><small>ç½•è¦‹(%)</small><input type="number" id="prob1" class="admin-input"></div>
                <div><small>ç¨€æœ‰(%)</small><input type="number" id="prob2" class="admin-input"></div>
                <div><small>å²è©©(%)</small><input type="number" id="prob3" class="admin-input"></div>
                <div><small>å‚³å¥‡(%)</small><input type="number" id="prob4" class="admin-input"></div>
                <div><small>ç¥è©±(%)</small><input type="number" id="prob5" class="admin-input"></div>
            </div>
            
            <label class="settings-label">ğŸ›¡ï¸ å°ä¿åº•è§¸ç™¼æ¬¡æ•¸ (å¿…ä¸­ç¨€æœ‰+)</label>
            <input type="number" id="setPityRare" class="admin-input" placeholder="é è¨­ 10">
            
            <label class="settings-label">ğŸ›¡ï¸ å¤§ä¿åº•è§¸ç™¼æ¬¡æ•¸</label>
            <input type="number" id="setPityLeg" class="admin-input" placeholder="é è¨­ 100">
            
            <label class="settings-label">ğŸ›¡ï¸ å¤§ä¿åº•çå‹µç›®æ¨™</label>
            <select id="setPityTarget" class="admin-input">
                <option value="5">ç¥è©± (é è¨­)</option>
                <option value="4">å‚³å¥‡ä»¥ä¸Š (å‚³å¥‡æˆ–ç¥è©±)</option>
            </select>
        </div>

        <div class="settings-group">
            <h4>ğŸ çå“å…§å®¹</h4>
            <label class="settings-label">çå“åº«æ¨¡å¼ï¼š</label>
            <div class="radio-group">
                <label><input type="radio" name="prizeScope" value="global" onclick="switchPrizeScope('global')" checked> å…¨å®¶å…±ç”¨ (é è¨­)</label>
                <label><input type="radio" name="prizeScope" value="individual" onclick="switchPrizeScope('individual')"> å€‹åˆ¥å°å­©è¨­å®š</label>
            </div>
            <p id="scopeHint" style="font-size:0.8rem; color:#666; background:#eee; padding:5px; border-radius:5px;">
                ç›®å‰æ¨¡å¼ï¼šæ‰€æœ‰å°å­©å…±ç”¨åŒä¸€å¥—çå“æ¸…å–®ã€‚
            </p>

            <select id="tierSelect" class="admin-input" onchange="renderPrizeManager()" style="font-weight:bold; color:#333;">
                <option value="0">æ™®é€š</option>
                <option value="1">ç½•è¦‹</option>
                <option value="2">ç¨€æœ‰</option>
                <option value="3">å²è©©</option>
                <option value="4">å‚³å¥‡</option>
                <option value="5">ç¥è©±</option>
            </select>
            <div style="display:flex; gap:5px; margin-bottom:10px;">
                <input id="newPrizeName" class="admin-input" style="margin:0;" placeholder="è¼¸å…¥æ–°çå“åç¨±">
                <button class="btn-admin" style="width:80px; background:#00b894;" onclick="addCustomPrize()">æ–°å¢</button>
            </div>
            <div id="prizeManagerList" style="max-height: 150px; overflow-y: auto; background:#f9f9f9; border:1px solid #eee; border-radius:5px;"></div>
            <div style="text-align:right; margin-top:5px;">
                 <button onclick="restoreDefaultPrizes()" style="font-size:0.8rem; color:#999; background:none; border:none; cursor:pointer; text-decoration:underline;">â†º æ¢å¾©é è¨­</button>
            </div>
        </div>

        <div class="settings-group">
            <h4>ğŸ‘¶ å°å­©ç®¡ç†</h4>
            <div id="settingsChildList"></div>
            <div style="margin-top:10px; display:flex; gap:5px;">
                <input id="settingsNewChildName" class="admin-input" style="margin:0;" placeholder="è¼¸å…¥æ–°åå­—">
                <button class="btn-admin" style="width:80px;" onclick="addNewChildFromSettings()">æ–°å¢</button>
            </div>
        </div>

        <div class="settings-group">
            <h4>ğŸ” å®‰å…¨èˆ‡å¸³è™Ÿ</h4>
            
            <label class="settings-label">å®¶é•·å¯†ç¢¼é– (PIN)</label>
            <div style="display:flex; gap:5px;">
                <button class="btn-admin" style="width:120px;" onclick="startSetPin()">è¨­å®š/ä¿®æ”¹å¯†ç¢¼</button>
                <button class="btn-admin" style="width:120px; background:#b2bec3;" onclick="removePin()">æ¸…é™¤å¯†ç¢¼</button>
            </div>
            <p style="font-size:0.8rem; color:#888;">è¨­å®šå¾Œï¼Œé€²å…¥å®¶é•·å€éœ€è¼¸å…¥å¯†ç¢¼ã€‚</p>

            <hr style="border:0; border-top:1px solid #eee; margin:15px 0;">

            <div id="guestBindSection" style="display:none; background:#fff3cd; padding:10px; border-radius:8px;">
                <label class="settings-label" style="color:#d35400;">ğŸ”— éŠå®¢è³‡æ–™è½‰æ­£ (ç¶å®š Email)</label>
                <input type="email" id="bindEmail" class="admin-input" placeholder="Email">
                <input type="password" id="bindPass" class="admin-input" placeholder="å¯†ç¢¼">
                <button class="btn-admin" onclick="bindGuestAccount()">ç¶å®šä¸¦ä¸Šå‚³</button>
            </div>

            <div id="userAccountSection" style="display:none;">
                <p>ç›®å‰ç™»å…¥ï¼š<strong id="settingsEmailDisplay"></strong></p>
                <button class="btn-admin" style="background:#636e72;" onclick="triggerResetPassword()">ğŸ“§ ç™¼é€é‡è¨­å¯†ç¢¼ä¿¡</button>
            </div>
        </div>

        <button class="btn-admin" onclick="saveSettings()">ğŸ’¾ å„²å­˜æ‰€æœ‰è¨­å®šä¸¦è¿”å›</button>
    </div>
</div>

<canvas id="confetti-canvas"></canvas>

<div class="user-bar">
    <span id="userEmail">æœªç™»å…¥</span>
    <button class="btn-logout" id="btnLogout">ç™»å‡º</button>
</div>

<div class="header">
    <div class="child-switcher-container">
        <div id="childSwitcher" class="child-switcher" onclick="toggleChildDropdown()">è®€å–ä¸­... â–¼</div>
        <div id="childDropdown" class="dropdown-menu"></div>
    </div>
    <div class="points-label">ç›®å‰æŒæœ‰çå‹µé»æ•¸</div>
    <div class="points-val" id="scoreDisplay">--</div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('tab-gacha')">ğŸ° æŠ½ç</button>
    <button class="nav-btn" onclick="switchTab('tab-bag')">ğŸ’ èƒŒåŒ…</button>
    <button class="nav-btn" onclick="switchTab('tab-bank')">ğŸ¦ éŠ€è¡Œ</button>
    <button class="nav-btn" onclick="switchTab('tab-admin')">âš™ï¸ å®¶é•·</button>
</div>

<div id="tab-gacha" class="section active">
    <div class="roulette-container">
        <div id="box-0" class="roulette-box box-common">æ™®é€š<span id="label-prob0">60%</span></div>
        <div id="box-1" class="roulette-box box-uncommon">ç½•è¦‹<span id="label-prob1">20%</span></div>
        <div id="box-2" class="roulette-box box-rare">ç¨€æœ‰<span id="label-prob2">10%</span></div>
        <div id="box-3" class="roulette-box box-epic">å²è©©<span id="label-prob3">6%</span></div>
        <div id="box-4" class="roulette-box box-legendary">å‚³å¥‡<span id="label-prob4">3%</span></div>
        <div id="box-5" class="roulette-box box-mythic">ç¥è©±<span id="label-prob5">1%</span></div>
    </div>
    <button id="btnDraw" class="big-btn" onclick="startGacha()">å•Ÿå‹•è½‰ç›¤ (-100é»)</button>
    <div class="pity-info">
        ğŸ›¡ï¸ <strong>ä¿åº•é€²åº¦</strong><br>
        å°ä¿åº• (ç¨€æœ‰+)ï¼š<span id="pityRareDisp" style="color:#0984e3; font-weight:bold;">0</span> / <span id="limitRare">10</span><br>
        å¤§ä¿åº• (<span id="limitTargetName">ç¥è©±</span>)ï¼š<span id="pityLegDisp" style="color:#d63031; font-weight:bold;">0</span> / <span id="limitLeg">100</span>
    </div>
    <div id="finalResult"><span style="color:#aaa">æº–å‚™æŠ½ç...</span></div>
</div>

<div id="tab-bag" class="section">
    <h3 style="border-left: 4px solid var(--rare); padding-left: 10px; color:#333;">ğŸ’ æˆ‘çš„çå“</h3>
    <div id="bagList"></div>
    <div id="bagEmpty" style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ç©ºç©ºçš„</div>
    
    <div style="text-align:center; margin-top: 30px; border-top: 1px dashed #ddd; padding-top: 20px;">
        <a href="https://suenz001.github.io/history-card-game/" target="_blank" class="btn-external-game">
            ğŸ® ä½œè€…æ¸¬è©¦ä¸­ç¶²é éŠæˆ²
        </a>
    </div>
</div>

<div id="tab-bank" class="section">
    <div class="bank-card">
        <div class="bank-rate">ğŸ“ˆ æ´»å­˜åˆ©ç‡ï¼š<span id="dispDailyRate">4%</span> / å¤©</div>
        <div class="bank-desc">æ¯æ™š <strong><span id="dispInterestHour">20</span>:00</strong> çµç®—ï¼Œè¨˜å¾—ä¾†é ˜åˆ©æ¯ï¼</div>
        <div style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:5px; border-radius:5px;">
            ä¸Šæ¬¡é ˜æ¯ï¼š<span id="lastInterestDate">ç„¡</span>
        </div>
        <div style="text-align:center; margin-top:10px;">
             <div style="font-size:0.8rem; margin-bottom:5px; color:#eee;">è·é›¢ä¸‹æ¬¡ç™¼åˆ©æ¯é‚„æœ‰ï¼š</div>
             <div id="interestTimer" class="bank-timer">--:--:--</div>
        </div>
    </div>
    <div class="deposit-form">
        <h3 style="margin-top:0; color:#2d3436;">ğŸ”’ ç”³è«‹è¶…ç´šå®šå­˜</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
            é–å®š <strong><span id="dispFixedDays">30</span> å¤©</strong>ï¼Œæ¯å¤©ç²åˆ© <strong><span id="dispFixedRate">7%</span></strong>ï¼<br>
            <span style="color:#d63031;">(è¶…é«˜å ±é…¬ï¼Œä½†æœŸé–“çµ•å°ä¸èƒ½é ˜å‡º)</span>
        </p>
        <input type="number" id="depositAmount" class="deposit-input" placeholder="è¼¸å…¥è¦å­˜çš„é»æ•¸">
        <button class="btn-deposit" onclick="createDeposit()">ç¢ºèªå­˜å…¥</button>
    </div>
    <h3 style="margin:20px 0 10px 0;">æˆ‘çš„å®šå­˜å–®</h3>
    <div id="depositList"></div>
    <div id="depositEmpty" style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰å®šå­˜</div>
</div>

<div id="tab-admin" class="section">
    <div class="admin-box">
        <h3>ğŸ’° ç™¼æ”¾é»æ•¸</h3>
        <input type="text" id="reasonIn" class="admin-input" placeholder="åŸå› ">
        <input type="number" id="pointsIn" class="admin-input" placeholder="é»æ•¸">
        <button class="btn-admin" onclick="addPoints()">ç™¼æ”¾</button>
    </div>

    <button class="btn-settings" onclick="openSettings()">âš™ï¸ é€²å…¥è©³ç´°è¨­å®š (å¯†ç¢¼/æ©Ÿç‡/ç®¡ç†)</button>

    <div class="admin-box" style="background:#f0f3ff; border:1px solid #dbe4ff; margin-top:20px;">
        <h3 style="color:#4a69bd;">ğŸ’¾ è³‡æ–™å‚™ä»½ (æœ¬åœ°ç«¯)</h3>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-backup" onclick="exportData()">â¬‡ï¸ åŒ¯å‡º</button>
            <button class="btn-restore" onclick="document.getElementById('importFile').click()">â¬†ï¸ åŒ¯å…¥</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
        </div>
    </div>

    <div class="admin-box">
        <h3>ğŸ“œ å­˜æ‘ºç´€éŒ„</h3>
        <div id="historyList" style="font-size:0.9rem; color:#666;"></div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="resetAll()" style="background:#ddd; border:none; padding:10px 20px; border-radius:20px; color:#666;">âš ï¸ é‡ç½®è³‡æ–™ (æ¸…ç©ºé›²ç«¯)</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === æ‚¨çš„ Firebase è¨­å®š ===
    const firebaseConfig = {
      apiKey: "AIzaSyCArCzhRG6H-07Ooet34ikyP3w9xVq6t1U",
      authDomain: "kidrewardapp.firebaseapp.com",
      projectId: "kidrewardapp",
      storageBucket: "kidrewardapp.firebasestorage.app",
      messagingSenderId: "980449979485",
      appId: "1:980449979485:web:652d6b419385e76ad071b4",
      measurementId: "G-L86Y9Y477Y"
    };

    let app, auth, db, userRef, analytics;
    let currentUser = null;
    let isGuest = false;

    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app);
        auth = getAuth(app);
        db = getFirestore(app);
    } catch (e) {
        console.error("Firebase Init Error:", e);
        document.getElementById('loginError').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š";
    }

    const loginOverlay = document.getElementById('loginOverlay');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnForgotPassword = document.getElementById('btnForgotPassword');
    const btnGuest = document.getElementById('btnGuest');
    const btnLogout = document.getElementById('btnLogout');
    const loadingMsg = document.getElementById('loadingMsg');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const errorMsg = document.getElementById('loginError');

    function handleAuthError(error) {
        loadingMsg.style.display = 'none';
        let msg = error.code;
        if (msg === 'auth/invalid-email') msg = "Email æ ¼å¼ä¸æ­£ç¢º";
        else if (msg === 'auth/user-not-found' || msg === 'auth/wrong-password' || msg === 'auth/invalid-credential') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        else if (msg === 'auth/email-already-in-use') msg = "æ­¤ Email å·²ç¶“è¨»å†Šéäº†";
        else if (msg === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼± (è‡³å°‘éœ€6ä½)";
        else if (msg === 'auth/missing-password') msg = "è«‹è¼¸å…¥å¯†ç¢¼";
        errorMsg.innerText = msg;
    }

    btnLogin.addEventListener('click', () => {
        const email = emailInput.value; const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        signInWithEmailAndPassword(auth, email, password).catch((error) => { handleAuthError(error); });
    });

    btnRegister.addEventListener('click', () => {
        const email = emailInput.value; const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        createUserWithEmailAndPassword(auth, email, password).then(() => { alert("è¨»å†ŠæˆåŠŸï¼å·²ç‚ºæ‚¨ç™»å…¥"); }).catch((error) => { handleAuthError(error); });
    });

    btnForgotPassword.addEventListener('click', () => {
        const email = emailInput.value;
        if(!email) { errorMsg.innerText = "è«‹è¼¸å…¥ Email å¾Œå†æŒ‰å¿˜è¨˜å¯†ç¢¼"; return; }
        loadingMsg.style.display = 'block'; errorMsg.innerText = "";
        sendPasswordResetEmail(auth, email).then(() => { loadingMsg.style.display = 'none'; alert("é‡è¨­ä¿¡å·²å¯„å‡ºï¼"); }).catch((error) => { handleAuthError(error); });
    });

    btnGuest.addEventListener('click', () => {
        isGuest = true;
        currentUser = { uid: 'guest', email: 'éŠå®¢æ¨¡å¼ (è³‡æ–™åƒ…å­˜æœ¬æ©Ÿ)' };
        document.getElementById('userEmail').innerText = currentUser.email;
        loginOverlay.style.display = 'none';
        loadDataFromLocal();
        setInterval(updateTimerAndDeposits, 1000);
    });

    btnLogout.addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) { 
            if(isGuest) location.reload();
            else signOut(auth).then(() => { location.reload(); }); 
        }
    });

    onAuthStateChanged(auth, async (user) => {
        if (user) {
            isGuest = false; currentUser = user;
            userRef = doc(db, "users", user.uid);
            document.getElementById('userEmail').innerText = user.email;
            loginOverlay.style.display = 'none';
            await loadDataFromCloud();
            setInterval(updateTimerAndDeposits, 1000);
        } else if(!isGuest) {
            loginOverlay.style.display = 'flex';
            loadingMsg.style.display = 'none';
        }
    });

    // === æ ¸å¿ƒè³‡æ–™çµæ§‹ ===
    const COST = 100;

    const DEFAULT_TIERS = [
        { id: 'common', index: 0, name: 'æ™®é€š', color: '#95a5a6', chance: 60, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸€è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 5åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•5åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“5åˆ†é˜'] },
        { id: 'uncommon', index: 1, name: 'ç½•è¦‹', color: '#00b894', chance: 20, rewards: ['å°æ—¥è¨˜æ¸›å°‘äºŒè¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•10åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“10åˆ†é˜'] },
        { id: 'rare', index: 2, name: 'ç¨€æœ‰', color: '#0984e3', chance: 10, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸‰è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 15åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“15åˆ†é˜', 'åª½åª½é™ªç¡è¦º'] },
        { id: 'epic', index: 3, name: 'å²è©©', color: '#6c5ce7', chance: 6, rewards: ['å°æ—¥è¨˜æ¸›å°‘å››è¡Œ', 'å¹³æ—¥å¯ç©é›»å‹•10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'å¢åŠ é»æ•¸200é»'] },
        { id: 'legendary', index: 4, name: 'å‚³å¥‡', color: '#e17055', chance: 3, rewards: ['å¹³æ—¥å¯ç©é›»å‹•15åˆ†é˜', 'é›¶ç”¨éŒ¢100å…ƒ', 'å¢åŠ é»æ•¸300é»'] },
        { id: 'mythic', index: 5, name: 'ç¥è©±', color: '#d63031', chance: 1, rewards: ['å¹³æ—¥å¯ç©é›»å‹•30åˆ†é˜', 'å¯ä»»æ„é¸è³¼500å…ƒå…§çš„å°ç¦®ç‰©', 'æ‰“æ‰‹å¿ƒè™•ç½°æ¸›å…ä¸€æ¬¡', 'å¢åŠ é»æ•¸500é»'] }
    ];

    // Master Data
    let masterData = {
        currentIdx: 0,
        settings: {
            dailyInterest: 0.04,
            interestHour: 20, // æ–°å¢ï¼šå¯è‡ªè¨‚ç™¼æ”¾æ™‚é–“
            fixedDepositRate: 0.07,
            fixedDepositDays: 30,
            adminPin: null,
            pityRareThreshold: 10, pityLegendaryThreshold: 100, pityBigTarget: 5, // 5=mythic, 4=legendary+
            prizeScope: 'global' // or 'individual'
        },
        tiers: JSON.parse(JSON.stringify(DEFAULT_TIERS)),
        children: [] 
    };

    // æŒ‡å‘ç•¶å‰å°å­©
    let data = null; 

    function createNewChildData() {
        return { score: 0, bag: [], history: [], pityRare: 0, pityLegendary: 0, lastLoginDate: "", deposits: [], tiers: JSON.parse(JSON.stringify(DEFAULT_TIERS)) };
    }

    function initMasterData(cloudData) {
        if (cloudData && cloudData.children) {
            masterData = cloudData;
            // è£œé½Šæ–°è¨­å®š
            if(!masterData.settings.pityRareThreshold) masterData.settings.pityRareThreshold = 10;
            if(!masterData.settings.pityLegendaryThreshold) masterData.settings.pityLegendaryThreshold = 100;
            if(!masterData.settings.prizeScope) masterData.settings.prizeScope = 'global';
            if(masterData.settings.interestHour === undefined) masterData.settings.interestHour = 20; // é è¨­ 20:00
        } else if (cloudData && cloudData.score !== undefined) {
            // èˆŠè½‰æ–°
            let oldData = { ...cloudData };
            delete oldData.tiers;
            masterData.tiers = cloudData.tiers || JSON.parse(JSON.stringify(DEFAULT_TIERS));
            masterData.settings = { dailyInterest: 0.04, interestHour: 20, fixedDepositRate: 0.07, fixedDepositDays: 30 };
            masterData.children = [{ name: "å¯¶è²1", data: oldData }];
            // ç¢ºä¿å°å­©ä¹Ÿæœ‰ tiers çµæ§‹ (for individual mode)
            masterData.children[0].data.tiers = JSON.parse(JSON.stringify(masterData.tiers));
        } else {
            // å…¨æ–°
            masterData.children = [{ name: "å¯¶è²1", data: createNewChildData() }];
            masterData.settings.interestHour = 20;
        }
        switchChild(masterData.currentIdx);
    }

    async function loadDataFromCloud() {
        try { const snap = await getDoc(userRef); initMasterData(snap.exists() ? snap.data() : null); saveData(); }
        catch (e) { alert("è®€å–å¤±æ•—"); }
    }
    function loadDataFromLocal() {
        const s = localStorage.getItem('kidGacha_v25'); initMasterData(s ? JSON.parse(s) : null);
    }
    function saveData() {
        // å¼·åˆ¶æ•¸å€¼ä¿®æ­£ (é¿å…æµ®é»æ•¸èª¤å·®)
        masterData.settings.dailyInterest = parseFloat(masterData.settings.dailyInterest.toFixed(4));
        masterData.settings.fixedDepositRate = parseFloat(masterData.settings.fixedDepositRate.toFixed(4));
        
        if (isGuest) { localStorage.setItem('kidGacha_v25', JSON.stringify(masterData)); updateUI(); }
        else if (currentUser) { setDoc(userRef, masterData).then(()=>updateUI()); }
    }

    // === UI & é‚è¼¯ ===
    window.toggleChildDropdown = function() { document.getElementById("childDropdown").classList.toggle("show"); }
    window.onclick = function(e) { if(!e.target.matches('.child-switcher')) { var d = document.getElementsByClassName("dropdown-menu"); for(var i=0; i<d.length; i++) if(d[i].classList.contains('show')) d[i].classList.remove('show'); } }

    window.switchChild = function(idx) {
        if(idx < 0 || idx >= masterData.children.length) idx = 0;
        masterData.currentIdx = idx;
        data = masterData.children[idx].data;
        document.getElementById('childSwitcher').innerText = masterData.children[idx].name + " â–¼";
        
        const dd = document.getElementById("childDropdown");
        dd.innerHTML = masterData.children.map((c, i) => `<div onclick="switchChild(${i})">${c.name} ${i === masterData.currentIdx ? 'âœ”' : ''}</div>`).join('');
        
        checkDailyInterest();
        updateUI();
    }

    // === PIN ç¢¼èˆ‡è¨­å®š ===
    let currentPinInput = "";
    let pinContext = 'login'; // 'login' (è§£é–) or 'setup' (è¨­å®š)
    
    window.switchTab = function(id) {
        if(id === 'tab-admin' && masterData.settings.adminPin) {
            pinContext = 'login';
            document.getElementById('pinTitle').innerText = "è«‹è¼¸å…¥å®¶é•·å¯†ç¢¼";
            document.getElementById('pinModal').style.display = 'flex';
            currentPinInput = "";
            updatePinDisplay();
            return;
        }
        performSwitchTab(id);
    }

    function performSwitchTab(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const buttons = document.querySelectorAll('.nav-btn');
        if(id==='tab-gacha') buttons[0].classList.add('active');
        if(id==='tab-bag') buttons[1].classList.add('active');
        if(id==='tab-bank') buttons[2].classList.add('active');
        if(id==='tab-admin') buttons[3].classList.add('active');
    }

    // è¨­å®šå¯†ç¢¼åŠŸèƒ½
    window.startSetPin = function() {
        pinContext = 'setup';
        currentPinInput = "";
        document.getElementById('pinTitle').innerText = "è«‹è¨­å®šæ–°å¯†ç¢¼ (4ä½æ•¸å­—)";
        document.getElementById('pinModal').style.display = 'flex';
        updatePinDisplay();
    }

    window.removePin = function() {
        if(confirm("ç¢ºå®šè¦ç§»é™¤å¯†ç¢¼ä¿è­·å—ï¼Ÿ")) {
            masterData.settings.adminPin = null;
            saveData();
            alert("å·²ç§»é™¤å¯†ç¢¼");
        }
    }

    window.enterPin = function(num) {
        if(currentPinInput.length < 4) {
            currentPinInput += num;
            updatePinDisplay();
            if(currentPinInput.length === 4) {
                // æª¢æŸ¥æ¨¡å¼
                if (pinContext === 'login') {
                    if(currentPinInput === masterData.settings.adminPin) {
                        closePin();
                        performSwitchTab('tab-admin');
                    } else {
                        alert("å¯†ç¢¼éŒ¯èª¤");
                        currentPinInput = "";
                        updatePinDisplay();
                    }
                } else if (pinContext === 'setup') {
                    masterData.settings.adminPin = currentPinInput;
                    saveData();
                    alert("å¯†ç¢¼å·²è¨­å®šï¼");
                    closePin();
                }
            }
        }
    }
    window.clearPin = function() { currentPinInput = currentPinInput.slice(0, -1); updatePinDisplay(); }
    window.closePin = function() { document.getElementById('pinModal').style.display = 'none'; }
    function updatePinDisplay() { document.getElementById('pinDisplay').innerText = "*".repeat(currentPinInput.length); }

    // === è¨­å®šè¦–çª— ===
    window.openSettings = function() {
        document.getElementById('settingsModal').style.display = 'block';
        document.getElementById('setDailyRate').value = masterData.settings.dailyInterest;
        document.getElementById('setInterestHour').value = masterData.settings.interestHour;
        document.getElementById('setFixedRate').value = masterData.settings.fixedDepositRate;
        document.getElementById('setFixedDays').value = masterData.settings.fixedDepositDays;
        document.getElementById('setPityRare').value = masterData.settings.pityRareThreshold;
        document.getElementById('setPityLeg').value = masterData.settings.pityLegendaryThreshold;
        document.getElementById('setPityTarget').value = masterData.settings.pityBigTarget || 5;
        // document.getElementById('adminPinInput').value = masterData.settings.adminPin || ""; // ç§»é™¤ Input é¡¯ç¤º
        
        // çå“ç¯„åœ
        const scope = masterData.settings.prizeScope || 'global';
        document.querySelector(`input[name="prizeScope"][value="${scope}"]`).checked = true;
        updateScopeHint(scope);

        // æ©Ÿç‡
        const currentTiers = getCurrentTiers();
        currentTiers.forEach((t, i) => document.getElementById(`prob${i}`).value = t.chance);

        // é¡¯ç¤ºç®¡ç†å€å¡Š
        document.getElementById('guestBindSection').style.display = isGuest ? 'block' : 'none';
        document.getElementById('userAccountSection').style.display = isGuest ? 'none' : 'block';
        if(!isGuest) document.getElementById('settingsEmailDisplay').innerText = currentUser.email;

        renderPrizeManager();
        renderSettingsChildList();
    }

    window.closeSettings = function() { document.getElementById('settingsModal').style.display = 'none'; }

    window.switchPrizeScope = function(scope) {
        updateScopeHint(scope);
        // å¦‚æœåˆ‡æ›åˆ°å€‹åˆ¥ï¼Œä¸”ç›®å‰æ²’è³‡æ–™ï¼Œè¤‡è£½å…¨åŸŸçš„éä¾†
        if(scope === 'individual' && (!data.tiers || data.tiers.length === 0)) {
            data.tiers = JSON.parse(JSON.stringify(masterData.tiers));
        }
        renderPrizeManager(); // é‡æ–°è®€å–æ­£ç¢ºçš„ tiers ä¾†æº
    }

    function updateScopeHint(scope) {
        const hint = document.getElementById('scopeHint');
        if(scope === 'global') hint.innerText = "ç›®å‰æ¨¡å¼ï¼šæ‰€æœ‰å°å­©å…±ç”¨åŒä¸€å¥—çå“æ¸…å–®ã€‚";
        else hint.innerText = "ç›®å‰æ¨¡å¼ï¼šç•¶å‰å°å­© (" + masterData.children[masterData.currentIdx].name + ") æ“æœ‰ç¨ç«‹çå“æ¸…å–®ã€‚";
    }

    // å–å¾—ç•¶å‰æ‡‰è©²ä½¿ç”¨çš„ Tiers
    function getCurrentTiers() {
        if (masterData.settings.prizeScope === 'individual') {
            if (!data.tiers) data.tiers = JSON.parse(JSON.stringify(masterData.tiers));
            return data.tiers;
        }
        return masterData.tiers;
    }

    window.saveSettings = function() {
        const dRate = parseFloat(document.getElementById('setDailyRate').value);
        const iHour = parseInt(document.getElementById('setInterestHour').value);
        const fRate = parseFloat(document.getElementById('setFixedRate').value);
        const fDays = parseInt(document.getElementById('setFixedDays').value);
        const pRare = parseInt(document.getElementById('setPityRare').value);
        const pLeg = parseInt(document.getElementById('setPityLeg').value);
        const pTarget = parseInt(document.getElementById('setPityTarget').value);
        const scope = document.querySelector('input[name="prizeScope"]:checked').value;

        if(iHour < 0 || iHour > 23) return alert("æ™‚é–“å¿…é ˆæ˜¯ 0~23");

        // é©—è­‰æ©Ÿç‡
        let totalProb = 0;
        let newProbs = [];
        for(let i=0; i<6; i++) {
            let p = parseFloat(document.getElementById(`prob${i}`).value);
            if(isNaN(p) || p < 0) return alert("æ©Ÿç‡éŒ¯èª¤");
            newProbs.push(p); totalProb += p;
        }
        if(Math.abs(totalProb - 100) > 0.1) return alert(`æ©Ÿç‡ç¸½å’Œå¿…é ˆç‚º 100% (ç›®å‰ ${totalProb}%)`);

        // å­˜å› masterData
        masterData.settings.dailyInterest = dRate;
        masterData.settings.interestHour = iHour;
        masterData.settings.fixedDepositRate = fRate;
        masterData.settings.fixedDepositDays = fDays;
        masterData.settings.pityRareThreshold = pRare;
        masterData.settings.pityLegendaryThreshold = pLeg;
        masterData.settings.pityBigTarget = pTarget;
        masterData.settings.prizeScope = scope;

        // å­˜å›æ©Ÿç‡åˆ°æ­£ç¢ºçš„ Tiers
        const targetTiers = getCurrentTiers();
        newProbs.forEach((p, i) => targetTiers[i].chance = p);

        saveData();
        updateUI();
        closeSettings();
        alert("è¨­å®šå·²å„²å­˜ï¼");
    }

    // === å°å­©ç®¡ç† (è¨­å®šé å…§) ===
    window.addNewChildFromSettings = function() {
        const name = document.getElementById('settingsNewChildName').value;
        if (!name) return alert("è«‹è¼¸å…¥åå­—");
        masterData.children.push({ name: name, data: createNewChildData() });
        document.getElementById('settingsNewChildName').value = '';
        saveData();
        renderSettingsChildList();
        // æ›´æ–°åˆ‡æ›é¸å–®
        document.getElementById("childDropdown").innerHTML = masterData.children.map((c, i) => `<div onclick="switchChild(${i})">${c.name}</div>`).join('');
    }

    window.renameChildSettings = function(idx) {
        const newName = prompt("æ–°åå­—:", masterData.children[idx].name);
        if(newName) { masterData.children[idx].name = newName; saveData(); renderSettingsChildList(); switchChild(masterData.currentIdx); }
    }

    window.deleteChildSettings = function(idx) {
        if (masterData.children.length <= 1) return alert("è‡³å°‘ä¿ç•™ä¸€ä½");
        if(confirm("ç¢ºå®šåˆªé™¤å—ï¼Ÿ")) { 
            masterData.children.splice(idx, 1); 
            if(masterData.currentIdx >= masterData.children.length) masterData.currentIdx = 0;
            saveData(); renderSettingsChildList(); switchChild(masterData.currentIdx);
        }
    }

    function renderSettingsChildList() {
        const list = document.getElementById('settingsChildList');
        list.innerHTML = masterData.children.map((c, i) => `
            <div class="child-row">
                <span>${c.name}</span>
                <div>
                    <button class="btn-mini-edit" onclick="renameChildSettings(${i})">æ”¹å</button>
                    <button class="btn-mini-del" onclick="deleteChildSettings(${i})">åˆªé™¤</button>
                </div>
            </div>
        `).join('');
    }

    // === å¸³è™ŸåŠŸèƒ½ ===
    window.bindGuestAccount = function() {
        const e = document.getElementById('bindEmail').value, p = document.getElementById('bindPass').value;
        if(!e || !p) return alert("è«‹è¼¸å…¥");
        createUserWithEmailAndPassword(auth, e, p).then(cred => {
            isGuest = false; currentUser = cred.user; userRef = doc(db, "users", currentUser.uid);
            saveData(); alert("ç¶å®šæˆåŠŸï¼"); location.reload();
        }).catch(err => alert(err.message));
    }
    
    window.triggerResetPassword = function() {
        if(currentUser && currentUser.email) {
            sendPasswordResetEmail(auth, currentUser.email).then(()=>alert("é‡è¨­ä¿¡å·²å¯„å‡º"));
        }
    }

    // === çå“ç®¡ç† (æ”¯æ´ Global/Individual) ===
    window.renderPrizeManager = function() {
        const select = document.getElementById('tierSelect'); 
        const listDiv = document.getElementById('prizeManagerList'); 
        const selectedIndex = parseInt(select.value); 
        
        const currentTiers = getCurrentTiers(); // æ ¹æ“šæ¨¡å¼å–å¾—æ­£ç¢ºçš„ tiers
        const tierData = currentTiers[selectedIndex];
        
        select.style.borderColor = tierData.color; select.style.color = tierData.color; 
        let html = '';
        if (tierData.rewards.length === 0) { html = '<div style="padding:10px; text-align:center; color:#999;">ç„¡çå“</div>'; } 
        else { tierData.rewards.forEach((reward, idx) => { html += `<div class="prize-manage-item"><span>${reward}</span><div><button class="btn-mini-edit" onclick="editPrize(${selectedIndex}, ${idx})">âœï¸</button><button class="btn-mini-del" onclick="removePrize(${selectedIndex}, ${idx})">ğŸ—‘ï¸</button></div></div>`; }); }
        listDiv.innerHTML = html;
    };

    window.addCustomPrize = function() {
        const tierIdx = parseInt(document.getElementById('tierSelect').value);
        const name = document.getElementById('newPrizeName').value.trim();
        if(!name) return;
        const currentTiers = getCurrentTiers();
        currentTiers[tierIdx].rewards.push(name);
        saveData(); document.getElementById('newPrizeName').value = ''; renderPrizeManager();
    };

    window.removePrize = function(tIdx, rIdx) {
        if(!confirm("åˆªé™¤ï¼Ÿ")) return;
        const currentTiers = getCurrentTiers();
        currentTiers[tIdx].rewards.splice(rIdx, 1);
        saveData(); renderPrizeManager();
    };

    window.editPrize = function(tIdx, rIdx) {
        const currentTiers = getCurrentTiers();
        const newName = prompt("ä¿®æ”¹:", currentTiers[tIdx].rewards[rIdx]);
        if(newName) { currentTiers[tIdx].rewards[rIdx] = newName; saveData(); renderPrizeManager(); }
    };

    window.restoreDefaultPrizes = function() {
        if(confirm("æ¢å¾©é è¨­çå“ï¼Ÿ")) {
            const defaultT = JSON.parse(JSON.stringify(DEFAULT_TIERS));
            if(masterData.settings.prizeScope === 'individual') {
                data.tiers = defaultT;
            } else {
                masterData.tiers = defaultT;
            }
            saveData(); renderPrizeManager(); alert("å·²æ¢å¾©");
        }
    };

    // === Gacha Logic (Updated for Pity Settings) ===
    window.startGacha = function() {
        if (data.score < COST) return;
        
        // ç¢ºä¿ child tiers å­˜åœ¨ (å¦‚æœå‰›åˆ‡æ›åˆ° individual æ¨¡å¼)
        if (masterData.settings.prizeScope === 'individual' && !data.tiers) {
            data.tiers = JSON.parse(JSON.stringify(masterData.tiers));
        }

        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        function playBeep(f,t,d){let o=audioCtx.createOscillator();let g=audioCtx.createGain();o.type=t;o.frequency.setValueAtTime(f,audioCtx.currentTime);g.gain.setValueAtTime(0.05,audioCtx.currentTime);g.gain.exponentialRampToValueAtTime(0.001,audioCtx.currentTime+d);o.connect(g);g.connect(audioCtx.destination);o.start();o.stop(audioCtx.currentTime+d);}
        
        data.score -= COST; 
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: 'åƒåŠ æŠ½ç', amount: -COST });

        const tiersSource = getCurrentTiers();
        let rand = Math.random() * 100;
        let cumulative = 0;
        let resultTier = tiersSource[0];
        
        // ä¿åº•é‚è¼¯
        const pityRareLimit = masterData.settings.pityRareThreshold || 10;
        const pityLegLimit = masterData.settings.pityLegendaryThreshold || 100;
        const pityTargetIdx = masterData.settings.pityBigTarget || 5;

        if (data.pityLegendary >= (pityLegLimit - 1)) {
            // å¤§ä¿åº•è§¸ç™¼
            if (pityTargetIdx === 4) { // å‚³å¥‡æˆ–ç¥è©± (50/50)
                resultTier = (Math.random() > 0.5) ? tiersSource[4] : tiersSource[5];
            } else {
                resultTier = tiersSource[5]; // å¿…ä¸­ç¥è©±
            }
        } else if (data.pityRare >= (pityRareLimit - 1)) {
            // å°ä¿åº•è§¸ç™¼ (ç¨€æœ‰ä»¥ä¸Š)
            // ç°¡å–®è™•ç†ï¼šå¾ index 2~5 éš¨æ©Ÿä¸€å€‹ï¼Œæˆ–ç›´æ¥çµ¦ç¨€æœ‰
            // é€™è£¡é‚è¼¯ç¶­æŒï¼šå¿…ä¸­ç¨€æœ‰ (index 2)
            resultTier = tiersSource[2]; 
        } else {
            // æ­£å¸¸æ©Ÿç‡
            for (let t of tiersSource) {
                cumulative += t.chance;
                if (rand <= cumulative) { resultTier = t; break; }
            }
        }

        // æ›´æ–°è¨ˆæ•¸å™¨
        if (resultTier.index === 5) { data.pityLegendary = 0; data.pityRare = 0; }
        else if (resultTier.index >= 2) { data.pityRare = 0; data.pityLegendary++; }
        else { data.pityRare++; data.pityLegendary++; }
        
        saveData();
        
        const btnDraw = document.getElementById('btnDraw');
        const finalResult = document.getElementById('finalResult');
        btnDraw.disabled = true;
        finalResult.innerHTML = '<span style="color:#999; font-size:1.5rem">ğŸ° è½‰å‹•ä¸­...</span>';
        
        let currentIdx = 0; const totalLoops = 5; 
        const boxes = document.querySelectorAll('.roulette-box');
        let speed = 40; let stepCount = 0; let totalSteps = (totalLoops * 6) + resultTier.index; 
        
        function step() {
            boxes.forEach(b => b.classList.remove('active'));
            document.getElementById(`box-${currentIdx}`).classList.add('active');
            playBeep(800, 'square', 0.03);
            if (stepCount >= totalSteps) {
                playBeep(600, 'sine', 0.1); 
                let finalReward = "éŠ˜è¬æƒ é¡§";
                if (resultTier.rewards && resultTier.rewards.length > 0) {
                    finalReward = resultTier.rewards[Math.floor(Math.random() * resultTier.rewards.length)];
                }
                finalResult.innerHTML = `<h2 style="color:${resultTier.color}">${resultTier.name}ç´šçå‹µï¼</h2><p style="font-weight:bold; font-size:1.3rem; color:#333;">${finalReward}</p>`;
                data.bag.unshift({ tierName: resultTier.name, color: resultTier.color, reward: finalReward, id: Date.now() });
                saveData();
                btnDraw.disabled = false; updateUI();
                if (resultTier.index >= 2) fireConfetti();
                return;
            }
            stepCount++; currentIdx++; if (currentIdx >= 6) currentIdx = 0;
            let remainingSteps = totalSteps - stepCount;
            if (remainingSteps < 8) speed += (10 - remainingSteps) * 20; else if (speed > 40) speed = 40;
            setTimeout(step, speed);
        }
        step();
    };

    // === å…¶ä»–åŠŸèƒ½ç¶­æŒä¸è®Šï¼Œåƒ…å¾®èª¿ ===
    window.useItem = function(idx) {
        const item = data.bag[idx]; if(!confirm('ç¢ºå®šè¦ä½¿ç”¨ã€Œ' + item.reward + 'ã€å—ï¼Ÿ')) return;
        const match = item.reward.match(/å¢åŠ é»æ•¸(\d+)é»/);
        if (match) { 
            const p = parseInt(match[1]); data.score += p; 
            data.history.push({ date: new Date().toLocaleDateString(), reason: `ä½¿ç”¨: ${item.reward}`, amount: p });
            alert(`ğŸŠ å·²å¢åŠ  ${p} é»ï¼`); 
        } else {
            data.history.push({ date: new Date().toLocaleDateString(), reason: `ä½¿ç”¨: ${item.reward}`, amount: 0 });
        }
        data.bag.splice(idx, 1); saveData();
    };

    window.addPoints = function() {
        const r = document.getElementById('reasonIn').value, p = parseInt(document.getElementById('pointsIn').value);
        if(!r || !p) return alert("è«‹è¼¸å…¥");
        data.score += p; 
        data.history.push({ date: new Date().toLocaleDateString(), reason: r, amount: p });
        saveData(); alert("å·²ç™¼æ”¾"); document.getElementById('reasonIn').value = '';
    };

    window.createDeposit = function() {
        const amt = parseInt(document.getElementById('depositAmount').value);
        if(!amt || amt <= 0 || amt > data.score) return alert("é‡‘é¡éŒ¯èª¤");
        const days = masterData.settings.fixedDepositDays;
        const rate = masterData.settings.fixedDepositRate;
        const estimatedProfit = Math.floor(amt * rate * days);
        const totalReturn = amt + estimatedProfit;

        if(!confirm(`å®šå­˜ ${amt} é»ï¼Ÿ\né–å®š ${days} å¤©\né è¨ˆç²åˆ© ${estimatedProfit}`)) return;
        
        data.score -= amt;
        const now = new Date(); const end = new Date(now); end.setDate(end.getDate() + days);
        data.deposits.push({ id: Date.now(), amount: amt, startDate: now.toISOString(), endDate: end.toISOString(), status: 'active' });
        data.history.push({ date: new Date().toLocaleDateString(), reason: "ç”³è«‹å®šå­˜", amount: -amt });
        saveData(); alert("æˆåŠŸ");
    };

    window.redeemDeposit = function(id) {
        const idx = data.deposits.findIndex(d => d.id === id); if(idx===-1) return;
        const dep = data.deposits[idx];
        const profit = Math.floor(dep.amount * masterData.settings.fixedDepositRate * masterData.settings.fixedDepositDays);
        data.score += (dep.amount + profit);
        data.history.push({ date: new Date().toLocaleDateString(), reason: "å®šå­˜é ˜å›", amount: (dep.amount+profit) });
        data.deposits.splice(idx, 1);
        saveData(); alert("å·²é ˜å›æœ¬é‡‘+åˆ©æ¯");
    };

    window.resetAll = function() { if(confirm("æ¸…ç©ºé‡ç½®ï¼Ÿ")) { masterData.children=[{name:"å¯¶è²1",data:createNewChildData()}]; masterData.currentIdx=0; saveData(); switchChild(0); } };

    window.updateTimerAndDeposits = function() {
        const now = new Date();
        let target = new Date(now); target.setHours(masterData.settings.interestHour, 0, 0, 0); if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const h = Math.floor((diff % (86400000)) / 3600000), m = Math.floor((diff % 3600000) / 60000), s = Math.floor((diff % 60000) / 1000);
        document.getElementById('interestTimer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        const list = document.getElementById('depositList');
        const empty = document.getElementById('depositEmpty');
        if (data.deposits.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        
        let html = '';
        data.deposits.forEach(d => {
            const end = new Date(d.endDate); const isMature = now >= end; const timeLeft = end - now;
            
            // é¡¯ç¤ºå­˜å…¥æ™‚é–“
            const startStr = new Date(d.startDate).toLocaleString();

            let timeStr = "";
            if (isMature) timeStr = "âœ… å¯é ˜å›";
            else {
                const days = Math.floor(timeLeft / 86400000);
                const hours = Math.floor((timeLeft % 86400000) / 3600000);
                const mins = Math.floor((timeLeft % 3600000) / 60000);
                timeStr = `â³ å‰© ${days}å¤©${hours}æ™‚${mins}åˆ†`;
            }
            const profit = Math.floor(d.amount * masterData.settings.fixedDepositRate * masterData.settings.fixedDepositDays);
            html += `<div class="deposit-item">
                        <div class="deposit-header"><span>æœ¬é‡‘: ${d.amount}</span><span style="color:#00b894;">(+${profit})</span></div>
                        <div style="font-size:0.75rem; color:#aaa; margin-top:2px;">ğŸ“… ${startStr}</div>
                        <div class="deposit-time">${timeStr}</div>
                        <button class="btn-redeem" onclick="redeemDeposit(${d.id})" ${isMature?'':'disabled'}>${isMature?'é ˜å–':'æœªåˆ°æœŸ'}</button>
                     </div>`;
        });
        list.innerHTML = html;
    };

    function checkDailyInterest() {
        const now = new Date(); const today = now.toDateString();
        if(now.getHours() < masterData.settings.interestHour) return;
        if(data.lastLoginDate !== today && data.score > 0) {
            const interest = Math.floor(data.score * masterData.settings.dailyInterest);
            if(interest > 0) {
                data.score += interest;
                data.history.push({ date: new Date().toLocaleDateString(), reason: "æ´»å­˜åˆ©æ¯", amount: interest });
                alert("åˆ©æ¯å…¥å¸³ +" + interest);
            }
            data.lastLoginDate = today; saveData();
        } else if(data.lastLoginDate === "") { data.lastLoginDate = today; saveData(); }
    }

    function updateUI() {
        document.getElementById('scoreDisplay').innerText = data.score;
        document.getElementById('dispDailyRate').innerText = parseFloat((masterData.settings.dailyInterest * 100).toFixed(2)) + '%';
        document.getElementById('dispInterestHour').innerText = masterData.settings.interestHour;
        document.getElementById('dispFixedRate').innerText = parseFloat((masterData.settings.fixedDepositRate * 100).toFixed(2)) + '%';
        document.getElementById('dispFixedDays').innerText = masterData.settings.fixedDepositDays;
        
        const currentTiers = getCurrentTiers();
        currentTiers.forEach((t, i) => {
            const el = document.getElementById(`label-prob${i}`);
            if(el) el.innerText = t.chance + "%";
        });

        document.getElementById('limitRare').innerText = masterData.settings.pityRareThreshold;
        document.getElementById('limitLeg').innerText = masterData.settings.pityLegendaryThreshold;
        document.getElementById('limitTargetName').innerText = (masterData.settings.pityBigTarget == 4) ? "å‚³å¥‡+" : "ç¥è©±";
        document.getElementById('pityRareDisp').innerText = data.pityRare;
        document.getElementById('pityLegDisp').innerText = data.pityLegendary;

        const btn = document.getElementById('btnDraw');
        if (data.score < COST) { btn.innerText = `é»æ•¸ä¸è¶³`; btn.disabled = true; } else { btn.innerText = `å•Ÿå‹•è½‰ç›¤ (-${COST}é»)`; btn.disabled = false; }
        
        const bagList = document.getElementById('bagList'); bagList.innerHTML = '';
        if (data.bag.length === 0) document.getElementById('bagEmpty').style.display = 'block';
        else {
            document.getElementById('bagEmpty').style.display = 'none';
            data.bag.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = 'list-item'; div.style.borderLeftColor = item.color;
                div.innerHTML = `<div><small style="color:${item.color};font-weight:bold;">${item.tierName}</small><br><span>${item.reward}</span></div><button class="btn-use" onclick="useItem(${idx})">ä½¿ç”¨</button>`;
                bagList.appendChild(div);
            });
        }
        const histList = document.getElementById('historyList');
        histList.innerHTML = data.history.slice().reverse().map(h => `<div style="border-bottom:1px solid #eee; padding:8px 0;">${h.date} - ${h.reason} <span style="float:right; font-weight:bold; color:${h.amount>0?'#00b894':'#e17055'}">${h.amount}</span></div>`).join('');
        window.updateTimerAndDeposits();
    }

    function fireConfetti() { const c = document.getElementById('confetti-canvas'); const ctx = c.getContext('2d'); c.width = window.innerWidth; c.height = window.innerHeight; let p = []; const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71']; for(let i=0; i<150; i++) p.push({x: c.width/2, y: c.height/2, r: Math.random()*6+2, dx: Math.random()*10-5, dy: Math.random()*10-5, color: colors[Math.floor(Math.random()*colors.length)], life: 100}); function d() { ctx.clearRect(0,0,c.width,c.height); let active = false; p.forEach(k => { if(k.life>0){ active=true; ctx.beginPath(); ctx.arc(k.x, k.y, k.r, 0, Math.PI*2); ctx.fillStyle=k.color; ctx.fill(); k.x+=k.dx; k.y+=k.dy; k.dy+=0.2; k.life--; }}); if(active) requestAnimationFrame(d); else ctx.clearRect(0,0,c.width,c.height); } d(); }

    window.exportData = function() { const json = JSON.stringify(masterData); const a = document.createElement('a'); a.href = URL.createObjectURL(new Blob([json], {type: "application/json"})); a.download = `reward_backup_${new Date().toISOString().slice(0,10)}.json`; document.body.appendChild(a); a.click(); document.body.removeChild(a); }
    window.importData = function(input) { 
        const file = input.files[0]; 
        if (!file || !confirm("åŒ¯å…¥æœƒè¦†è“‹è³‡æ–™ï¼Œç¢ºå®šï¼Ÿ")) return; 
        const reader = new FileReader(); 
        reader.onload = function(e) { 
            try { 
                const imported = JSON.parse(e.target.result); 
                // åŒ¯å…¥é‚è¼¯ï¼šè‡ªå‹•ä¿®å¾©èˆ‡å‡ç´š
                if (imported.children) { 
                    // v19+ å¤šäººç‰ˆæ ¼å¼
                    masterData = imported; 
                } else { 
                    // v18- å–®äººç‰ˆæ ¼å¼
                    // 1. å¦‚æœèˆŠæª”æ¡ˆæœ‰ tiersï¼ŒæŠ“å‡ºä¾†è®Šæˆå…¨åŸŸçå“ (é¿å…è®Šå›é è¨­)
                    if(imported.tiers) {
                        masterData.tiers = imported.tiers;
                    }
                    // 2. è½‰æ›è³‡æ–™çµæ§‹
                    masterData.children = [{name:"å¯¶è²1", data:imported}]; 
                    masterData.currentIdx=0; 
                    
                    // 3. è£œé½Šå¯èƒ½ç¼ºå¤±çš„ settings
                    if(!masterData.settings) {
                        masterData.settings = { 
                            dailyInterest: 0.04, interestHour: 20, fixedDepositRate: 0.07, fixedDepositDays: 30,
                            pityRareThreshold: 10, pityLegendaryThreshold: 100, prizeScope: 'global'
                        };
                    }
                } 
                saveData(); 
                alert("é‚„åŸæˆåŠŸï¼"); 
                switchChild(0); 
            } catch(err) { 
                alert("æ ¼å¼éŒ¯èª¤"); 
            } 
        }; 
        reader.readAsText(file); 
        input.value = ''; 
    }
</script>
</body>
</html>