<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>è¶…ç´šå¹¸é‹æŠ½æŠ½æ¨‚ - é›²ç«¯æ•´åˆç‰ˆ</title>
    <style>
        :root {
            --bg-color: #f0f2f5;
            --header-bg: #ffffff;
            --text-color: #333333;
            --primary: #4a90e2;
            --success: #00b894;
            --danger: #d63031;
            --warning: #f1c40f;
            
            --common: #95a5a6;
            --uncommon: #00b894;
            --rare: #0984e3;
            --epic: #6c5ce7;
            --legendary: #e17055;
            --mythic: #d63031;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            user-select: none;
            -webkit-user-select: none;
            overflow-x: hidden;
            padding-bottom: 60px;
        }

        /* === ğŸ”´ æ–°å¢ï¼šç™»å…¥ä»‹é¢æ¨£å¼ === */
        #loginOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 255, 255, 0.98);
            z-index: 9999;
            display: flex; flex-direction: column; justify-content: center; align-items: center;
            text-align: center;
        }
        .login-card {
            background: white; padding: 30px; border-radius: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            width: 85%; max-width: 350px;
        }
        .login-input {
            width: 100%; padding: 12px; margin: 8px 0;
            border: 1px solid #ccc; border-radius: 8px;
            box-sizing: border-box; font-size: 1rem;
        }
        .btn-group-login {
            display: flex; gap: 10px; margin-top: 15px;
        }
        .btn-login {
            flex: 1; background: #4a90e2; color: white; border: none; padding: 12px;
            font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        .btn-register {
            flex: 1; background: #00b894; color: white; border: none; padding: 12px;
            font-size: 1rem; border-radius: 8px; cursor: pointer; font-weight: bold;
        }
        #loadingMsg { color: #888; margin-top: 10px; font-size: 0.9rem; display: none; }
        #loginError { color: red; font-size: 0.8rem; margin-top: 10px; min-height: 1.2em; }

        .user-bar {
            background: #2d3436; color: white; padding: 8px 15px;
            display: flex; justify-content: space-between; align-items: center;
            font-size: 0.85rem;
        }
        .btn-logout {
            background: #d63031; border: none; color: white;
            padding: 4px 10px; border-radius: 4px; cursor: pointer; font-size: 0.8rem;
        }

        /* === Header === */
        .header {
            background: var(--header-bg);
            padding: 20px;
            text-align: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        .points-val { font-size: 3rem; font-weight: 800; color: #fab1a0; margin: 5px 0; }
        .points-label { font-size: 0.9rem; color: #888; font-weight: bold; }

        /* === Navigation === */
        .nav {
            display: flex;
            background: white;
            margin: 15px;
            border-radius: 12px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            padding: 5px;
        }
        .nav-btn {
            flex: 1;
            padding: 10px;
            background: none;
            border: none;
            color: #888;
            font-weight: bold;
            cursor: pointer;
            border-radius: 8px;
            transition: all 0.2s;
            font-size: 0.9rem;
        }
        .nav-btn.active { background: #dfe6e9; color: #2d3436; }

        /* === Sections === */
        .section { display: none; padding: 10px 20px; max-width: 600px; margin: 0 auto; animation: fadeIn 0.3s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        /* === Gacha Roulette === */
        .roulette-container { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin: 20px 0; }
        .roulette-box {
            background: #e9ecef; border-radius: 12px; padding: 20px 5px; text-align: center;
            font-weight: 800; font-size: 1.2rem; opacity: 0.6; color: #555;
            border: 3px solid transparent; border-bottom-width: 5px;
            display: flex; flex-direction: column; justify-content: center; min-height: 80px;
        }
        .roulette-box span { font-size: 0.8rem; font-weight: normal; margin-top: 5px; opacity: 0.8; }
        .roulette-box.active { opacity: 1; transform: scale(1.05); background: #fff; box-shadow: 0 5px 20px rgba(0,0,0,0.15); z-index: 10; }

        /* Color Bindings */
        .box-common { border-color: var(--common); } .box-common.active { color: var(--common); }
        .box-uncommon { border-color: var(--uncommon); } .box-uncommon.active { color: var(--uncommon); }
        .box-rare { border-color: var(--rare); } .box-rare.active { color: var(--rare); }
        .box-epic { border-color: var(--epic); } .box-epic.active { color: var(--epic); }
        .box-legendary { border-color: var(--legendary); } .box-legendary.active { color: var(--legendary); }
        .box-mythic { border-color: var(--mythic); } .box-mythic.active { color: var(--mythic); }

        /* Buttons */
        .big-btn { width: 100%; padding: 18px; font-size: 1.4rem; font-weight: bold; border-radius: 50px; border: none; background: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%); color: white; box-shadow: 0 4px 10px rgba(9, 132, 227, 0.4); cursor: pointer; margin-top: 15px; }
        .big-btn:disabled { background: #b2bec3; box-shadow: none; cursor: not-allowed; }

        /* Results & Lists */
        #finalResult { margin-top: 25px; padding: 20px; border-radius: 15px; text-align: center; background: white; box-shadow: 0 4px 15px rgba(0,0,0,0.05); min-height: 80px; display: flex; flex-direction: column; justify-content: center; }
        .list-item { background: white; border-left: 6px solid #ccc; margin-bottom: 10px; padding: 15px; border-radius: 8px; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.03); }
        .btn-use { background: #ff7675; color: white; border: none; padding: 6px 15px; border-radius: 20px; cursor: pointer; font-weight: bold; }

        /* Pity Info */
        .pity-info { background: #fff8e1; color: #d35400; padding: 10px; border-radius: 10px; font-size: 0.85rem; margin-top: 20px; text-align: center; border: 1px solid #ffe0b2; }

        /* === Bank Section Styles === */
        .bank-card { background: linear-gradient(135deg, #00b09b, #96c93d); color: white; padding: 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,176,155,0.3); }
        .bank-rate { font-size: 1.5rem; font-weight: bold; }
        .bank-desc { font-size: 0.9rem; opacity: 0.9; margin-bottom: 10px; }
        .bank-timer { font-family: monospace; font-size: 1.1rem; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 8px; margin-top: 10px; display: inline-block; font-weight: bold;}
        
        .deposit-form { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .deposit-input { width: 100%; padding: 12px; margin: 10px 0; border: 2px solid #eee; border-radius: 10px; font-size: 1.2rem; box-sizing: border-box; text-align: center; }
        .btn-deposit { width: 100%; padding: 12px; background: #00b894; color: white; border: none; border-radius: 10px; font-size: 1.1rem; cursor: pointer; font-weight: bold; }

        .deposit-item { background: white; border: 1px solid #eee; border-radius: 10px; padding: 15px; margin-bottom: 10px; position: relative; overflow: hidden; }
        .deposit-item::before { content: "ğŸ”’"; position: absolute; right: -10px; top: -10px; font-size: 3rem; opacity: 0.1; }
        .deposit-header { display: flex; justify-content: space-between; font-weight: bold; color: #2d3436; margin-bottom: 5px; }
        .deposit-time { font-size: 0.85rem; color: #636e72; }
        .btn-redeem { width: 100%; margin-top: 10px; padding: 8px; background: #fdcb6e; color: #d35400; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; }
        .btn-redeem:disabled { background: #dfe6e9; color: #b2bec3; cursor: not-allowed; }

        /* Admin Styles */
        .admin-box { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); margin-bottom: 20px; }
        .admin-input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        .btn-admin { background: #0984e3; color: white; padding: 10px; width: 100%; border: none; border-radius: 5px; cursor: pointer; }
        
        /* Prize Manager Styles */
        .prize-manage-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid #eee; }
        .btn-mini-del { background: #ff7675; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; margin-left: 5px;}
        .btn-mini-edit { background: #74b9ff; color: white; border: none; border-radius: 5px; padding: 4px 8px; cursor: pointer; font-size: 0.8rem; }
        
        /* Backup Buttons */
        .btn-backup { background: #6c5ce7; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }
        .btn-restore { background: #e17055; color: white; padding: 10px; border: none; border-radius: 5px; cursor: pointer; width: 48%; }

        #confetti-canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 999; }
    </style>
</head>
<body>

<div id="loginOverlay">
    <div class="login-card">
        <h2 style="margin-top:0; color:#4a90e2;">å¥½å­©å­çå‹µ App</h2>
        <p style="color:#666; margin-bottom:20px; font-size:0.9rem;">è«‹ç™»å…¥æˆ–è¨»å†Šä»¥åŒæ­¥é›²ç«¯è³‡æ–™</p>
        
        <input type="email" id="emailInput" class="login-input" placeholder="é›»å­ä¿¡ç®± (Email)">
        <input type="password" id="passwordInput" class="login-input" placeholder="å¯†ç¢¼ (è‡³å°‘6ä½æ•¸)">
        
        <div class="btn-group-login">
            <button id="btnLogin" class="btn-login">ç™»å…¥</button>
            <button id="btnRegister" class="btn-register">è¨»å†Šæ–°å¸³è™Ÿ</button>
        </div>

        <div id="loadingMsg">è³‡æ–™è®€å–ä¸­...</div>
        <p id="loginError"></p>
    </div>
</div>

<canvas id="confetti-canvas"></canvas>

<div class="user-bar">
    <span id="userEmail">æœªç™»å…¥</span>
    <button class="btn-logout" id="btnLogout">ç™»å‡º</button>
</div>

<div class="header">
    <div class="points-label">ç›®å‰æŒæœ‰çå‹µé»æ•¸</div>
    <div class="points-val" id="scoreDisplay">--</div>
</div>

<div class="nav">
    <button class="nav-btn active" onclick="switchTab('tab-gacha')">ğŸ° æŠ½ç</button>
    <button class="nav-btn" onclick="switchTab('tab-bag')">ğŸ’ èƒŒåŒ…</button>
    <button class="nav-btn" onclick="switchTab('tab-bank')">ğŸ¦ éŠ€è¡Œ</button>
    <button class="nav-btn" onclick="switchTab('tab-admin')">âš™ï¸ å®¶é•·</button>
</div>

<div id="tab-gacha" class="section active">
    <div class="roulette-container">
        <div id="box-0" class="roulette-box box-common">æ™®é€š<span>60%</span></div>
        <div id="box-1" class="roulette-box box-uncommon">ç½•è¦‹<span>20%</span></div>
        <div id="box-2" class="roulette-box box-rare">ç¨€æœ‰<span>10%</span></div>
        <div id="box-3" class="roulette-box box-epic">å²è©©<span>6%</span></div>
        <div id="box-4" class="roulette-box box-legendary">å‚³å¥‡<span>3%</span></div>
        <div id="box-5" class="roulette-box box-mythic">ç¥è©±<span>1%</span></div>
    </div>
    <button id="btnDraw" class="big-btn" onclick="startGacha()">å•Ÿå‹•è½‰ç›¤ (-100é»)</button>
    <div class="pity-info">
        ğŸ›¡ï¸ <strong>ä¿åº•é€²åº¦ï¼š</strong><br>
        å°ä¿åº•(ç¨€æœ‰+)ï¼š<span id="pityRareDisp" style="color:#0984e3; font-weight:bold;">0</span>/10<br>
        å¤§ä¿åº•(ç¥è©±!)ï¼š<span id="pityLegDisp" style="color:#d63031; font-weight:bold;">0</span>/100
    </div>
    <div id="finalResult"><span style="color:#aaa">æº–å‚™æŠ½ç...</span></div>
</div>

<div id="tab-bag" class="section">
    <h3 style="border-left: 4px solid var(--rare); padding-left: 10px; color:#333;">ğŸ’ æˆ‘çš„çå“</h3>
    <div id="bagList"></div>
    <div id="bagEmpty" style="text-align:center; color:#999; padding:20px;">èƒŒåŒ…ç©ºç©ºçš„</div>
</div>

<div id="tab-bank" class="section">
    <div class="bank-card">
        <div class="bank-rate">ğŸ“ˆ æ´»å­˜åˆ©ç‡ï¼š4% / å¤©</div>
        <div class="bank-desc">æ¯æ™š <strong>20:00</strong> çµç®—ï¼Œè¨˜å¾—ä¾†é ˜åˆ©æ¯ï¼</div>
        <div style="font-size:0.8rem; background:rgba(255,255,255,0.2); padding:5px; border-radius:5px;">
            ä¸Šæ¬¡é ˜æ¯ï¼š<span id="lastInterestDate">ç„¡</span>
        </div>
        <div style="text-align:center; margin-top:10px;">
             <div style="font-size:0.8rem; margin-bottom:5px; color:#eee;">è·é›¢ä¸‹æ¬¡ç™¼åˆ©æ¯é‚„æœ‰ï¼š</div>
             <div id="interestTimer" class="bank-timer">--:--:--</div>
        </div>
    </div>

    <div class="deposit-form">
        <h3 style="margin-top:0; color:#2d3436;">ğŸ”’ ç”³è«‹è¶…ç´šå®šå­˜</h3>
        <p style="font-size:0.9rem; color:#666; margin-bottom:10px;">
            é–å®š <strong>30 å¤©</strong>ï¼Œæ¯å¤©ç²åˆ© <strong>7%</strong>ï¼<br>
            <span style="color:#d63031;">(è¶…é«˜å ±é…¬ï¼Œä½†æœŸé–“çµ•å°ä¸èƒ½é ˜å‡º)</span>
        </p>
        <input type="number" id="depositAmount" class="deposit-input" placeholder="è¼¸å…¥è¦å­˜çš„é»æ•¸">
        <button class="btn-deposit" onclick="createDeposit()">ç¢ºèªå­˜å…¥</button>
    </div>

    <h3 style="margin:20px 0 10px 0;">æˆ‘çš„å®šå­˜å–®</h3>
    <div id="depositList"></div>
    <div id="depositEmpty" style="text-align:center; color:#999;">ç›®å‰æ²’æœ‰å®šå­˜</div>
</div>

<div id="tab-admin" class="section">
    <div class="admin-box">
        <h3>ğŸ’° ç™¼æ”¾é»æ•¸</h3>
        <input type="text" id="reasonIn" class="admin-input" placeholder="åŸå› ">
        <input type="number" id="pointsIn" class="admin-input" placeholder="é»æ•¸">
        <button class="btn-admin" onclick="addPoints()">ç™¼æ”¾</button>
    </div>

    <div class="admin-box" style="border: 2px solid #fdcb6e;">
        <h3 style="color:#d35400;">ğŸ çå“ç®¡ç†</h3>
        <p style="font-size:0.8rem; color:#666;">é¸æ“‡ç­‰ç´šï¼Œç·¨è¼¯è©²ç­‰ç´šçš„çå“å…§å®¹ã€‚</p>
        
        <select id="tierSelect" class="admin-input" onchange="renderPrizeManager()" style="font-weight:bold; color:#333;">
            <option value="0">æ™®é€š (60%)</option>
            <option value="1">ç½•è¦‹ (20%)</option>
            <option value="2">ç¨€æœ‰ (10%)</option>
            <option value="3">å²è©© (6%)</option>
            <option value="4">å‚³å¥‡ (3%)</option>
            <option value="5">ç¥è©± (1%)</option>
        </select>

        <div style="display:flex; gap:5px; margin-bottom:10px;">
            <input id="newPrizeName" class="admin-input" style="margin:0;" placeholder="è¼¸å…¥æ–°çå“åç¨±">
            <button class="btn-admin" style="width:80px; background:#00b894;" onclick="addCustomPrize()">æ–°å¢</button>
        </div>

        <div id="prizeManagerList" style="max-height: 200px; overflow-y: auto; background:#f9f9f9; border:1px solid #eee; border-radius:5px;"></div>
        
        <div style="text-align:right; margin-top:10px;">
             <button onclick="restoreDefaultPrizes()" style="font-size:0.8rem; color:#999; background:none; border:none; cursor:pointer; text-decoration:underline;">â†º æ¢å¾©é è¨­çå“</button>
        </div>
    </div>

    <div class="admin-box" style="background:#f0f3ff; border:1px solid #dbe4ff;">
        <h3 style="color:#4a69bd;">ğŸ’¾ è³‡æ–™å‚™ä»½ (æœ¬åœ°ç«¯)</h3>
        <div style="display:flex; justify-content:space-between;">
            <button class="btn-backup" onclick="exportData()">â¬‡ï¸ åŒ¯å‡º</button>
            <button class="btn-restore" onclick="document.getElementById('importFile').click()">â¬†ï¸ åŒ¯å…¥</button>
            <input type="file" id="importFile" style="display:none" onchange="importData(this)" accept=".json">
        </div>
        <p style="font-size:0.8rem; color:#888; margin-bottom:0;">æ³¨æ„ï¼šåŒ¯å…¥æœƒè¦†è“‹é›²ç«¯è³‡æ–™</p>
    </div>

    <div class="admin-box">
        <h3>ğŸ“œ å­˜æ‘ºç´€éŒ„</h3>
        <div id="historyList" style="font-size:0.9rem; color:#666;"></div>
    </div>

    <div style="text-align:center; margin-top:20px;">
        <button onclick="resetAll()" style="background:#ddd; border:none; padding:10px 20px; border-radius:20px; color:#666;">âš ï¸ é‡ç½®è³‡æ–™ (æ¸…ç©ºé›²ç«¯)</button>
    </div>
</div>

<script type="module">
    // === ğŸ”´ 1. å¼•å…¥ Firebase SDK (Auth æ”¹ç‚ºä½¿ç”¨ Email/Password) ===
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-analytics.js";
    import { getAuth, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // === ğŸŸ¢ 2. CONFIG AREA ===
    const firebaseConfig = {
      apiKey: "AIzaSyCArCzhRG6H-07Ooet34ikyP3w9xVq6t1U",
      authDomain: "kidrewardapp.firebaseapp.com",
      projectId: "kidrewardapp",
      storageBucket: "kidrewardapp.firebasestorage.app",
      messagingSenderId: "980449979485",
      appId: "1:980449979485:web:652d6b419385e76ad071b4",
      measurementId: "G-L86Y9Y477Y"
    };

    // === 3. åˆå§‹åŒ– Firebase ===
    let app, auth, db, userRef, analytics;
    let currentUser = null;

    try {
        app = initializeApp(firebaseConfig);
        analytics = getAnalytics(app);
        auth = getAuth(app);
        db = getFirestore(app);
        console.log("Firebase initialized");
    } catch (e) {
        console.error("Firebase Init Error:", e);
        document.getElementById('loginError').innerText = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹æª¢æŸ¥è¨­å®š";
    }

    // === 4. ç™»å…¥/è¨»å†Š é‚è¼¯ (Email/Password) ===
    const loginOverlay = document.getElementById('loginOverlay');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnLogout = document.getElementById('btnLogout');
    const loadingMsg = document.getElementById('loadingMsg');
    const emailInput = document.getElementById('emailInput');
    const passwordInput = document.getElementById('passwordInput');
    const errorMsg = document.getElementById('loginError');

    function handleAuthError(error) {
        loadingMsg.style.display = 'none';
        let msg = error.code;
        if (msg === 'auth/invalid-email') msg = "Email æ ¼å¼ä¸æ­£ç¢º";
        else if (msg === 'auth/user-not-found' || msg === 'auth/wrong-password' || msg === 'auth/invalid-credential') msg = "å¸³è™Ÿæˆ–å¯†ç¢¼éŒ¯èª¤";
        else if (msg === 'auth/email-already-in-use') msg = "æ­¤ Email å·²ç¶“è¨»å†Šéäº†";
        else if (msg === 'auth/weak-password') msg = "å¯†ç¢¼å¤ªå¼± (è‡³å°‘éœ€6ä½)";
        else if (msg === 'auth/missing-password') msg = "è«‹è¼¸å…¥å¯†ç¢¼";
        errorMsg.innerText = msg;
    }

    // ç™»å…¥æŒ‰éˆ•
    btnLogin.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }
        
        loadingMsg.style.display = 'block';
        errorMsg.innerText = "";
        
        signInWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                // æˆåŠŸç™»å…¥
            })
            .catch((error) => {
                handleAuthError(error);
            });
    });

    // è¨»å†ŠæŒ‰éˆ•
    btnRegister.addEventListener('click', () => {
        const email = emailInput.value;
        const password = passwordInput.value;
        if(!email || !password) { errorMsg.innerText="è«‹è¼¸å…¥å¸³è™Ÿå¯†ç¢¼"; return; }

        loadingMsg.style.display = 'block';
        errorMsg.innerText = "";

        createUserWithEmailAndPassword(auth, email, password)
            .then((userCredential) => {
                alert("è¨»å†ŠæˆåŠŸï¼å·²ç‚ºæ‚¨ç™»å…¥");
            })
            .catch((error) => {
                handleAuthError(error);
            });
    });

    btnLogout.addEventListener('click', () => {
        if(confirm("ç¢ºå®šè¦ç™»å‡ºå—ï¼Ÿ")) {
            signOut(auth).then(() => {
                location.reload();
            });
        }
    });

    // ç›£è½ç™»å…¥ç‹€æ…‹
    onAuthStateChanged(auth, async (user) => {
        if (user) {
            // å·²ç™»å…¥
            currentUser = user;
            userRef = doc(db, "users", user.uid);
            document.getElementById('userEmail').innerText = user.email;
            loginOverlay.style.display = 'none';
            // è¼‰å…¥è³‡æ–™
            await loadDataFromCloud();
            // å•Ÿå‹•å®šæ™‚å™¨
            setInterval(updateTimerAndDeposits, 1000);
        } else {
            // æœªç™»å…¥
            loginOverlay.style.display = 'flex';
            loadingMsg.style.display = 'none';
        }
    });

    // === 5. è³‡æ–™å­˜å– (é›²ç«¯æ ¸å¿ƒ) ===
    
    // è¨­å®š
    const COST = 100;
    const DAILY_INTEREST_RATE = 0.04;      
    const FIXED_DEPOSIT_DAILY_RATE = 0.07; 
    const INTEREST_HOUR = 20;              
    const FIXED_DEPOSIT_DAYS = 30; 

    // é è¨­è³‡æ–™ (å®Œæ•´ä¿ç•™ v13 é è¨­)
    const DEFAULT_TIERS = [
        { id: 'common', index: 0, name: 'æ™®é€š', color: '#95a5a6', chance: 60, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸€è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 5åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•5åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“5åˆ†é˜'] },
        { id: 'uncommon', index: 1, name: 'ç½•è¦‹', color: '#00b894', chance: 20, rewards: ['å°æ—¥è¨˜æ¸›å°‘äºŒè¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•10åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“10åˆ†é˜'] },
        { id: 'rare', index: 2, name: 'ç¨€æœ‰', color: '#0984e3', chance: 10, rewards: ['å°æ—¥è¨˜æ¸›å°‘ä¸‰è¡Œ', 'å‡æ—¥ç©é›»å‹•åŠ 15åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•15åˆ†é˜', 'æ¸›å°‘çœ‹æ›¸æ™‚é–“15åˆ†é˜', 'åª½åª½é™ªç¡è¦º'] },
        { id: 'epic', index: 3, name: 'å²è©©', color: '#6c5ce7', chance: 6, rewards: ['å°æ—¥è¨˜æ¸›å°‘å››è¡Œ', 'å¹³æ—¥å¯ç©é›»å‹•10åˆ†é˜', 'å‡æ—¥çˆ¸çˆ¸é™ªç©é›»å‹•30åˆ†é˜', 'å¢åŠ é»æ•¸200é»'] },
        { id: 'legendary', index: 4, name: 'å‚³å¥‡', color: '#e17055', chance: 3, rewards: ['å¹³æ—¥å¯ç©é›»å‹•15åˆ†é˜', 'é›¶ç”¨éŒ¢100å…ƒ', 'å¢åŠ é»æ•¸300é»'] },
        { id: 'mythic', index: 5, name: 'ç¥è©±', color: '#d63031', chance: 1, rewards: ['å¹³æ—¥å¯ç©é›»å‹•30åˆ†é˜', 'å¯ä»»æ„é¸è³¼500å…ƒå…§çš„å°ç¦®ç‰©', 'æ‰“æ‰‹å¿ƒè™•ç½°æ¸›å…ä¸€æ¬¡', 'å¢åŠ é»æ•¸500é»'] }
    ];

    let data = {
        score: 0, bag: [], history: [], pityRare: 0, pityLegendary: 0, lastLoginDate: "", deposits: [], tiers: null
    };

    // å¾é›²ç«¯è¼‰å…¥
    async function loadDataFromCloud() {
        try {
            const docSnap = await getDoc(userRef);
            if (docSnap.exists()) {
                const cloudData = docSnap.data();
                data = { ...data, ...cloudData };
                
                // ç¢ºä¿ tiers çµæ§‹å­˜åœ¨
                if (!data.tiers || data.tiers.length === 0) {
                    data.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS));
                }
                
                checkDailyInterest();
                updateUI();
                renderPrizeManager();
                console.log("é›²ç«¯è³‡æ–™åŒæ­¥å®Œæˆ");
            } else {
                console.log("æ–°ç”¨æˆ¶ï¼Œå»ºç«‹åˆå§‹è³‡æ–™");
                data.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS));
                saveDataToCloud(); // å¯«å…¥åˆå§‹è³‡æ–™
                updateUI();
                renderPrizeManager();
            }
        } catch (e) {
            console.error(e);
            alert("è®€å–é›²ç«¯è³‡æ–™å¤±æ•—ï¼š" + e.message + "\n(è«‹ç¢ºèªæª”æ¡ˆå·²ä¸Šå‚³è‡³ç¶²é ç©ºé–“)");
        }
    }

    // å­˜å…¥é›²ç«¯
    async function saveDataToCloud() {
        if (!currentUser) return;
        try {
            await setDoc(userRef, data);
            updateUI();
        } catch (e) {
            console.error("å­˜æª”å¤±æ•—", e);
        }
    }

    // --- éŸ³æ•ˆèˆ‡å‹•ç•« ---
    let audioCtx = null;
    function initAudio() { if (!audioCtx) { const AudioContext = window.AudioContext || window.webkitAudioContext; audioCtx = new AudioContext(); const osc = audioCtx.createOscillator(); osc.connect(audioCtx.destination); osc.start(); osc.stop(0.01); } }
    function playBeep(freq, type, duration) { if (!audioCtx) return; const osc = audioCtx.createOscillator(); const gain = audioCtx.createGain(); osc.type = type; osc.frequency.setValueAtTime(freq, audioCtx.currentTime); gain.gain.setValueAtTime(0.05, audioCtx.currentTime); gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration); osc.connect(gain); gain.connect(audioCtx.destination); osc.start(); osc.stop(audioCtx.currentTime + duration); }
    
    function fireConfetti() {
        const c = document.getElementById('confetti-canvas'); const ctx = c.getContext('2d');
        c.width = window.innerWidth; c.height = window.innerHeight;
        let p = []; const colors = ['#f1c40f', '#e74c3c', '#3498db', '#9b59b6', '#2ecc71'];
        for(let i=0; i<150; i++) p.push({x: c.width/2, y: c.height/2, r: Math.random()*6+2, dx: Math.random()*10-5, dy: Math.random()*10-5, color: colors[Math.floor(Math.random()*colors.length)], life: 100});
        function d() {
            ctx.clearRect(0,0,c.width,c.height); let active = false;
            p.forEach(k => { if(k.life>0){ active=true; ctx.beginPath(); ctx.arc(k.x, k.y, k.r, 0, Math.PI*2); ctx.fillStyle=k.color; ctx.fill(); k.x+=k.dx; k.y+=k.dy; k.dy+=0.2; k.life--; }});
            if(active) requestAnimationFrame(d); else ctx.clearRect(0,0,c.width,c.height);
        }
        d();
    }

    // === 6. åŠŸèƒ½å‡½å¼ (æ›è¼‰åˆ° window ä»¥ä¾› HTML å‘¼å«) ===
    
    window.switchTab = function(id) {
        document.querySelectorAll('.section').forEach(d => d.classList.remove('active'));
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active');
        const buttons = document.querySelectorAll('.nav-btn');
        if(id==='tab-gacha') buttons[0].classList.add('active');
        if(id==='tab-bag') buttons[1].classList.add('active');
        if(id==='tab-bank') buttons[2].classList.add('active');
        if(id==='tab-admin') { buttons[3].classList.add('active'); renderPrizeManager(); }
    };

    window.startGacha = function() {
        if (!data.tiers) data.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS));
        if (data.score < COST) return;
        initAudio();
        data.score -= COST;
        recordHistory('åƒåŠ æŠ½ç', -COST);
        
        let resultTier = null;
        if (data.pityLegendary >= 99) resultTier = data.tiers[5];
        else if (data.pityRare >= 9) resultTier = data.tiers[2];
        else {
            const rand = Math.random() * 100; let cumulative = 0; resultTier = data.tiers[0];
            for (let t of data.tiers) { cumulative += t.chance; if (rand <= cumulative) { resultTier = t; break; } }
        }
        if (resultTier.index === 5) { data.pityLegendary = 0; data.pityRare = 0; }
        else if (resultTier.index >= 2) { data.pityRare = 0; data.pityLegendary++; }
        else { data.pityRare++; data.pityLegendary++; }
        
        saveDataToCloud();
        
        const btnDraw = document.getElementById('btnDraw');
        const finalResult = document.getElementById('finalResult');
        btnDraw.disabled = true;
        finalResult.innerHTML = '<span style="color:#999; font-size:1.5rem">ğŸ° è½‰å‹•ä¸­...</span>';
        
        let currentIdx = 0; const totalLoops = 5; 
        const boxes = document.querySelectorAll('.roulette-box');
        let speed = 40; let stepCount = 0; let totalSteps = (totalLoops * 6) + resultTier.index; 
        
        function step() {
            boxes.forEach(b => b.classList.remove('active'));
            document.getElementById(`box-${currentIdx}`).classList.add('active');
            playBeep(800, 'square', 0.03);
            if (stepCount >= totalSteps) {
                playBeep(600, 'sine', 0.1); setTimeout(() => playBeep(1200, 'sine', 0.3), 150);
                let finalReward = "éŠ˜è¬æƒ é¡§";
                if (resultTier.rewards && resultTier.rewards.length > 0) {
                    finalReward = resultTier.rewards[Math.floor(Math.random() * resultTier.rewards.length)];
                }
                finalResult.innerHTML = `<h2 style="color:${resultTier.color}">${resultTier.name}ç´šçå‹µï¼</h2><p style="font-weight:bold; font-size:1.3rem; color:#333;">${finalReward}</p>`;
                data.bag.unshift({ tierName: resultTier.name, color: resultTier.color, reward: finalReward, id: Date.now() });
                saveDataToCloud();
                btnDraw.disabled = false; updateUI();
                if (resultTier.index >= 2) fireConfetti();
                return;
            }
            stepCount++; currentIdx++; if (currentIdx >= 6) currentIdx = 0;
            let remainingSteps = totalSteps - stepCount;
            if (remainingSteps < 8) speed += (10 - remainingSteps) * 20; else if (speed > 40) speed = 40;
            setTimeout(step, speed);
        }
        step();
    };

    window.useItem = function(idx) {
        const item = data.bag[idx];
        if(!confirm(`ç¢ºå®šä½¿ç”¨ã€Œ${item.reward}ã€å—ï¼Ÿ`)) return;
        const match = item.reward.match(/å¢åŠ é»æ•¸(\d+)é»/);
        if (match) {
            const p = parseInt(match[1]); data.score += p;
            recordHistory(`ä½¿ç”¨é»æ•¸å¡: ${item.reward}`, p);
            alert(`ğŸŠ å·²å¢åŠ  ${p} é»ï¼`);
        } else {
            recordHistory(`ä½¿ç”¨: ${item.reward}`, 0);
        }
        data.bag.splice(idx, 1);
        saveDataToCloud();
    };

    window.addPoints = function() {
        const r = document.getElementById('reasonIn').value;
        const p = parseInt(document.getElementById('pointsIn').value);
        if (!r || !p) return alert('è«‹è¼¸å…¥å®Œæ•´è³‡è¨Š');
        data.score += p; recordHistory(r, p); saveDataToCloud();
        alert(`å·²ç™¼æ”¾ ${p} é»`); document.getElementById('reasonIn').value = '';
    };

    window.createDeposit = function() {
        const amount = parseInt(document.getElementById('depositAmount').value);
        if (!amount || amount <= 0) return alert("è«‹è¼¸å…¥æ­£ç¢ºé‡‘é¡");
        if (amount > data.score) return alert("é»æ•¸ä¸è¶³ï¼");
        const estimatedProfit = Math.floor(amount * FIXED_DEPOSIT_DAILY_RATE * FIXED_DEPOSIT_DAYS);
        const totalReturn = amount + estimatedProfit;
        if(!confirm(`ç¢ºå®šè¦å°‡ ${amount} é»å­˜å…¥å®šå­˜å—ï¼Ÿ\n\nğŸ“… é–å®š ${FIXED_DEPOSIT_DAYS} å¤©\nğŸ“ˆ é è¨ˆç²åˆ© +${estimatedProfit} é»\nğŸ’° åˆ°æœŸå¯é ˜ ${totalReturn} é»\n\næœŸé–“å…§ç„¡æ³•å–å‡ºå–”ï¼`)) return;
        data.score -= amount;
        const now = new Date(); const endDate = new Date(now); endDate.setDate(endDate.getDate() + FIXED_DEPOSIT_DAYS); 
        data.deposits.push({ id: Date.now(), amount: amount, startDate: now.toISOString(), endDate: endDate.toISOString(), status: 'active' });
        recordHistory(`ğŸ¦ ç”³è«‹å®šå­˜`, -amount); saveDataToCloud(); alert("å®šå­˜ç”³è«‹æˆåŠŸï¼"); document.getElementById('depositAmount').value = "";
    };

    window.redeemDeposit = function(id) {
        const idx = data.deposits.findIndex(d => d.id === id); if (idx === -1) return;
        const deposit = data.deposits[idx];
        const principal = deposit.amount;
        const interest = Math.floor(principal * FIXED_DEPOSIT_DAILY_RATE * FIXED_DEPOSIT_DAYS);
        const total = principal + interest;
        data.score += total; recordHistory(`ğŸ’° å®šå­˜åˆ°æœŸé ˜å›`, total);
        data.deposits.splice(idx, 1); saveDataToCloud();
        alert(`æ­å–œï¼å®šå­˜åˆ°æœŸï¼\næœ¬é‡‘ï¼š${principal}\nåˆ©æ¯ï¼š${interest}\nç¸½å…±ç²å¾—ï¼š${total} é»ï¼`);
    };

    window.resetAll = function() {
        if(confirm('âš ï¸ è­¦å‘Šï¼šé€™å°‡æœƒæ¸…é™¤é›²ç«¯ä¸Šçš„æ‰€æœ‰è³‡æ–™ï¼ç¢ºå®šå—ï¼Ÿ')) {
            data = { score: 0, bag: [], history: [], pityRare: 0, pityLegendary: 0, lastLoginDate: "", deposits: [], tiers: JSON.parse(JSON.stringify(DEFAULT_TIERS)) };
            saveDataToCloud();
        }
    };

    window.renderPrizeManager = function() {
        const select = document.getElementById('tierSelect');
        const listDiv = document.getElementById('prizeManagerList');
        const selectedIndex = parseInt(select.value);
        const tierData = data.tiers[selectedIndex];
        select.style.borderColor = tierData.color; select.style.color = tierData.color;
        let html = '';
        if (tierData.rewards.length === 0) { html = '<div style="padding:10px; text-align:center; color:#999;">æ­¤ç­‰ç´šç›®å‰æ²’æœ‰çå“</div>'; } 
        else {
            tierData.rewards.forEach((reward, idx) => {
                html += `<div class="prize-manage-item"><span>${reward}</span><div><button class="btn-mini-edit" onclick="editPrize(${selectedIndex}, ${idx})">âœï¸</button><button class="btn-mini-del" onclick="removePrize(${selectedIndex}, ${idx})">ğŸ—‘ï¸</button></div></div>`;
            });
        }
        listDiv.innerHTML = html;
    };
    window.addCustomPrize = function() {
        const select = document.getElementById('tierSelect');
        const input = document.getElementById('newPrizeName');
        const name = input.value.trim();
        const tierIdx = parseInt(select.value);
        if (!name) return alert("è«‹è¼¸å…¥çå“åç¨±");
        data.tiers[tierIdx].rewards.push(name); saveDataToCloud(); input.value = ''; renderPrizeManager();
    };
    window.removePrize = function(tierIdx, rewardIdx) {
        if(!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${data.tiers[tierIdx].rewards[rewardIdx]}ã€å—ï¼Ÿ`)) return;
        data.tiers[tierIdx].rewards.splice(rewardIdx, 1); saveDataToCloud(); renderPrizeManager();
    };
    window.editPrize = function(tierIdx, rewardIdx) {
        const oldName = data.tiers[tierIdx].rewards[rewardIdx];
        const newName = prompt("ä¿®æ”¹çå“åç¨±ï¼š", oldName);
        if (newName && newName.trim() !== "") {
            data.tiers[tierIdx].rewards[rewardIdx] = newName.trim(); saveDataToCloud(); renderPrizeManager();
        }
    };
    window.restoreDefaultPrizes = function() {
        if(confirm("âš ï¸ ç¢ºå®šè¦æ¢å¾©æˆã€Œé è¨­çå“ã€å—ï¼Ÿ")) {
            data.tiers = JSON.parse(JSON.stringify(DEFAULT_TIERS)); saveDataToCloud(); renderPrizeManager(); alert("å·²æ¢å¾©é è¨­å€¼ã€‚");
        }
    };

    // éŠ€è¡Œå®šæ™‚æ›´æ–°
    window.updateTimerAndDeposits = function() {
        const now = new Date();
        let target = new Date(now); target.setHours(INTEREST_HOUR, 0, 0, 0);
        if (now > target) target.setDate(target.getDate() + 1);
        const diff = target - now;
        const h = Math.floor((diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
        const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const s = Math.floor((diff % (1000 * 60)) / 1000);
        document.getElementById('interestTimer').innerText = `${String(h).padStart(2,'0')}:${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
        
        const list = document.getElementById('depositList');
        const empty = document.getElementById('depositEmpty');
        if (data.deposits.length === 0) { list.innerHTML = ''; empty.style.display = 'block'; return; }
        empty.style.display = 'none';
        let html = '';
        data.deposits.forEach(d => {
            const end = new Date(d.endDate); const isMature = now >= end; const timeLeft = end - now;
            let timeStr = isMature ? "âœ… å·²åˆ°æœŸï¼Œå¯é ˜å›" : `â³ é–å®šä¸­ (å‰© ${Math.floor(timeLeft / (1000 * 60 * 60 * 24))}å¤©)`;
            const profit = Math.floor(d.amount * FIXED_DEPOSIT_DAILY_RATE * FIXED_DEPOSIT_DAYS);
            html += `<div class="deposit-item"><div class="deposit-header"><span>æœ¬é‡‘: ${d.amount}</span><span style="color:#00b894; font-size:0.9rem;">(é æœŸ+${profit})</span></div><div class="deposit-time">${timeStr}</div><button class="btn-redeem" onclick="redeemDeposit(${d.id})" ${isMature ? '' : 'disabled'}>${isMature ? 'ğŸ’° ç«‹å³é ˜å–' : 'æœªåˆ°æœŸ'}</button></div>`;
        });
        list.innerHTML = html;
    };

    // å…§éƒ¨è¼”åŠ©
    function checkDailyInterest() {
        const now = new Date(); const currentHour = now.getHours(); const todayStr = now.toDateString();
        if (currentHour < INTEREST_HOUR) return;
        if (data.lastLoginDate !== todayStr && data.score > 0) {
            const interest = Math.floor(data.score * DAILY_INTEREST_RATE);
            if (interest > 0) {
                data.score += interest; recordHistory(`ğŸ’° å¤œé–“æ´»å­˜çµç®— (4%)`, interest);
                alert(`ğŸŒ™ æ™šä¸Šå¥½ï¼\néŠ€è¡Œåˆ©æ¯å·²å…¥å¸³ï¼š+${interest} é»ï¼`);
            }
            data.lastLoginDate = todayStr; saveDataToCloud();
        } else if (data.lastLoginDate === "") {
            data.lastLoginDate = todayStr; saveDataToCloud();
        }
    }
    function updateUI() {
        document.getElementById('scoreDisplay').innerText = data.score;
        document.getElementById('lastInterestDate').innerText = data.lastLoginDate || "ç„¡";
        const btn = document.getElementById('btnDraw');
        if (data.score < COST) { btn.innerText = `é»æ•¸ä¸è¶³ (ç¼º${COST - data.score})`; btn.disabled = true; } 
        else { btn.innerText = `å•Ÿå‹•è½‰ç›¤ (-${COST}é»)`; btn.disabled = false; }
        const bagList = document.getElementById('bagList'); bagList.innerHTML = '';
        if (data.bag.length === 0) document.getElementById('bagEmpty').style.display = 'block';
        else {
            document.getElementById('bagEmpty').style.display = 'none';
            data.bag.forEach((item, idx) => {
                const div = document.createElement('div'); div.className = 'list-item'; div.style.borderLeftColor = item.color;
                div.innerHTML = `<div><small style="color:${item.color};font-weight:bold;">${item.tierName}</small><br><span>${item.reward}</span></div><button class="btn-use" onclick="useItem(${idx})">ä½¿ç”¨</button>`;
                bagList.appendChild(div);
            });
        }
        const histList = document.getElementById('historyList');
        histList.innerHTML = data.history.slice().reverse().map(h => `<div style="border-bottom:1px solid #eee; padding:8px 0;">${h.date} - ${h.reason} <span style="float:right; font-weight:bold; color:${h.amount>0?'#00b894':'#e17055'}">${h.amount}</span></div>`).join('');
        document.getElementById('pityRareDisp').innerText = data.pityRare; document.getElementById('pityLegDisp').innerText = data.pityLegendary;
        window.updateTimerAndDeposits();
    }
    function recordHistory(r, a) {
        const now = new Date(); const d = `${now.getMonth()+1}/${now.getDate()} ${String(now.getHours()).padStart(2,'0')}:${String(now.getMinutes()).padStart(2,'0')}`;
        data.history.push({ date: d, reason: r, amount: a });
    }

    // æœ¬åœ°å‚™ä»½ (ä¿ç•™åŠŸèƒ½)
    window.exportData = function() {
        const json = JSON.stringify(data);
        const a = document.createElement('a');
        a.href = URL.createObjectURL(new Blob([json], {type: "application/json"}));
        a.download = `reward_backup_${new Date().toISOString().slice(0,10)}.json`;
        document.body.appendChild(a); a.click(); document.body.removeChild(a);
    }
    window.importData = function(input) {
        const file = input.files[0];
        if (!file || !confirm("âš ï¸ è­¦å‘Šï¼šåŒ¯å…¥æ–°æª”æ¡ˆå°‡æœƒã€Œè¦†è“‹ã€ç›®å‰çš„é›²ç«¯ç´€éŒ„ï¼\nç¢ºå®šè¦ç¹¼çºŒå—ï¼Ÿ")) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            try {
                const imported = JSON.parse(e.target.result);
                if (imported.score !== undefined) { 
                    data = { ...data, ...imported }; 
                    saveDataToCloud(); 
                    alert("âœ… è³‡æ–™é‚„åŸæˆåŠŸï¼Œä¸¦å·²åŒæ­¥è‡³é›²ç«¯ï¼"); 
                }
            } catch(err) { alert("âŒ æ ¼å¼éŒ¯èª¤"); }
        };
        reader.readAsText(file);
        input.value = '';
    }

</script>
</body>
</html>